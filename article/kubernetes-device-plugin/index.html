<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Halo的主页 - Kubernetes Device Plugin 开发详解</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&display=swap" rel=stylesheet><link rel=stylesheet href=../../css/halo.css><link rel=stylesheet href=../../css/github-markdown.css><link rel=stylesheet href=../../css/github-markdown-light.css><link rel=stylesheet href=../../css/markdown-rewrite.css><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><style>body{display:flex;flex-direction:column;align-items:center}a{color:#5e5e5e;text-decoration:none}</style></head><body><div id=mob-warning>当前内容暂不适配移动端。<br>请使用桌面端查看。</div><div id=top style=width:0;height:0></div><div class=top-button><a href=#top style=text-decoration:none>Top</a></div><div id=toc>目<br>录</div><div id=header><div style=width:100%;display:flex;align-items:center;height:100%><div class=disable-select style=display:flex;justify-content:flex-end;font-size:14pt;font-weight:700;color:#555><div style=margin-right:35px></div><div><a style=color:#555;text-decoration:none href=../../>&lt;Halo的主页/></a></div></div><div style=flex:1;display:flex;justify-content:flex-end;font-size:14pt;font-weight:700;color:#555><div style=margin-right:45px><a href=../../article style=color:#555;text-decoration:none>文章</a></div><div style=margin-right:45px><a href=../../about style=color:#555;text-decoration:none>关于</a></div><div style=margin-left:35px></div></div></div></div><div id=article-content><div class=content-header><div>《Kubernetes Device Plugin 开发详解》</div><div style=font-size:10pt;height:100%;display:flex;align-items:flex-end;padding-bottom:12pt;color:#5e5e5e;font-weight:lighter>在2023/07/30 16:49:46更新，大约共2600字。</div></div><div class=content-desc><div style=font-size:50pt;font-weight:700;color:#eee;padding-right:15px>“</div><div style=line-height:50pt;color:#9b9b9b>学习 Device Plugin 开发</div><div style=font-size:50pt;font-weight:700;color:#eee;padding-left:15px>”</div></div><div class="content-area markdown-body"><p>云原生最初来描述云上应用的典型架构与特性，随着容器、Kubernetes、Serverless、FaaS技术的演进，CNCF（云原生计算基金会）把云原生的概念更广泛地定义为“让应用更有弹性、容错性、观测性的基础技术，让应用更容易部署、管理的基础软件、让应用更容易编写、编排的运行框架等”，希望能够让开发者最好的利用云的资源、产品和交付能力。云上的资源具备多样性，并且有些硬件资源很难被 Kubernetes 管理。Kubernetes 提供 Extended Resources 和 Device Plugin 方案来实现异构资源的管理。</p><p>我在工作的过程中使用了 AMD 和 NVIDIA 显卡来开展 AI 任务，一些对性能要求更高的场景下使用了 FPGA 方案，例如ffmpeg、x264、x265 等音视频工具，亦或是高频交易需要模式识别等场景。在 Kubernetes 集群中运行 TensorFlow、PyTorch等机器学习框架需要用到 PCIe 设备。社区中的 Device Plugin 方案在学术界和工程界具有较大的差异，目前 Device Plugin 只能说是可以用的地步。</p><p>为什么需要用 Kubernetes 来管理 PCIe 设备（异构资源）呢？</p><ul><li>提升部署速度，通过 Docker、Podman 的方式加速部署不同类型或版本的环境。例如在私有镜像仓库中准备多个版本的 CUDA 镜像。</li><li>提升资源使用率，使用 Kubernetes 进行集中管理。遗憾的是 NVIDIA 提供的 Device Plugin 只能实现简单的 GPU 数量汇报。</li><li>资源独立，利用容器实现对异构设备的隔离性，避免相互影响。例如 NVIDIA 的多实例 GPU 可以实现一个 GPU 板卡可以承载多个 Pod。</li></ul><p><img src=../../article/kubernetes-device-plugin/1045756-cdna2-tech-1260x709.webp alt></p><h1 id=俯瞰-device-plugin>俯瞰 Device Plugin</h1><p>通常情况下安装 CUDA 的时候，会通过 CUDA Toolkit Installer 进行安装，这个安装器自带了 CUDA 和 GPU 驱动，但是不同的框架或应用可能使用不同的 CUDA 版本，这就导致 CUDA 版本与 GPU 驱动版本可能不匹配使得无法正常工作。通常来讲 GPU 提供了从硬件层面上的多实例，为了在不同实例上运行不同的 CUDA 版本，我们可以通过 mount bind 的方式（<code>--device=/dev/nvidia0</code>）构建容器镜像。在内核层面安装 GPU 驱动，然后在镜像内安装容器中的 GPU 驱动，将物理的 GPU 设备映射到容器中，如下图所示：</p><p><img src=../../article/kubernetes-device-plugin/gpu-containers.svg alt></p><p>NVIDIA GPU 需要替换 Docker 的 RunC，安装 nvidia-docker2 即可实现自动替换。AMD Instinct 的 ROCm 方案就不需要单独的 RunC。</p><p>Kubernetes Extended Resources 通过自定义资源扩展的方式，允许用户分配和使用不是 Kubernetes 中内建的资源，而 Device Plugin 允许第三方设备厂商以插件的方式对设备的调度和生命周期进行管控。Extended Resources 属于 Node 级别的 API，通过 <code>application/json-patch+json</code> 类型的 HTTP PATCH 请求可以上报资源数量，然后在 Pod YAML 中使用 <code>nvidia.com/gpu: 1</code> 进行声明。</p><p>如果使用 Device Plugin 框架，那么直接遵循框架的编程模型即可。Device Plugin 主要完成两件事情：</p><ul><li>异构资源的监控与上报</li><li>Pod 所需资源的分配</li></ul><p>目前 NVIDIA 提供的 Device Plugin 无法实现更加复杂的调度，例如 GPU 亲和性调度（调度到同一个 NUMA 节点上）、全局 GPU 调度、NV Link/NV Switch 识别等。</p><p><img src=../../article/kubernetes-device-plugin/device-plugin-flow.svg alt></p><p>Kubelet 中有 Device Plugin Manager，维护了当前 Node 上的设备，并且通知 Kubernetes API Server 资源的清单，Kubernetes API Server 主要的任务就是在 ETCD 中存储这些资源清单。Kubelet 启动以后会创建一个 DaemonSet，这个 DaemonSet 就是我们部署的 Device Plugin，这个 DaemonSet Pod 会向 Kubelet 中的 Device Plugin Manager 发送注册请求，主要做三件事情：汇报设备类型、通知 Unix Socket 位置与通知 API 版本和协议。</p><p>Kubelet 上的 Device Plugin Manager 会启动一个 Device Plugin Client 去通过得知的 Unix Socket 连接 DaemonSet Pod 中的 Device Plugin Server（本质是个 gRPC Server）实现 ListAndWatch API。这样 Node 上的设备数量变化就可以在 Kubernetes 上的 Extended Resource 数量上发生变化了。</p><p>现有的 Device Plugin 中，如果 Pod 想使用 GPU 资源，直接在 YAML 中这样声明：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>resources</span>:
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>limits</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>nvidia.com/gpu</span>: <span style=color:#ff9f43>2</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>amd.com/gpu</span>: <span style=color:#ff9f43>2</span>
</span></span></code></pre></td></tr></table></div></div><p>Kubernetes Scheduler 会选择出满足条件的 Node，然后在 Node 上创建 Pod。具体的过程是 Device Plugin Manager 会在持有的 GPU 列表中选择出 GPU ID，然后通过 Allocate 请求向 Device Plugin Server 发送分配请求，Server 向 Manager 响应（Envs, Devices, Mounts）三元组，然后由 Kubelet 创建容器。</p><p>虽然 Kubernetes 提供了 Device Plugin 和 Extended Resources 的方案来管理异构资源，但是目前也有巨大的缺陷：</p><ul><li>设备调度发生在 Kubelet 层面，也就是 Node 层面，而不是 Cluster 层名，更不是 Data Center 层面。</li><li>资源上报的信息只有数量，信息不足，精细度也不够。</li><li>调度策略太简单，并且无法配置，没办法满足复杂场景。</li></ul><p>另外的一些 Device Plugin 解决方案：</p><ul><li>Alibaba GPU Share Device Plugin: 阿里巴巴提出的方案，包括 <a href=https://github.com/AliyunContainerService/gpushare-scheduler-extender>https://github.com/AliyunContainerService/gpushare-scheduler-extender</a> 和 <a href=https://github.com/AliyunContainerService/gpushare-device-plugin>https://github.com/AliyunContainerService/gpushare-device-plugin</a>。</li><li>RDMA Device Plugin: <a href=https://github.com/Mellanox/k8s-rdma-shared-dev-plugin>https://github.com/Mellanox/k8s-rdma-shared-dev-plugin</a> 和 <a href=https://github.com/Mellanox/k8s-rdma-sriov-dev-plugin>https://github.com/Mellanox/k8s-rdma-sriov-dev-plugin</a>。</li><li>FPGA Device Plugin: <a href=https://github.com/Xilinx/FPGA_as_a_Service/tree/master/k8s-device-plugin>https://github.com/Xilinx/FPGA_as_a_Service/tree/master/k8s-device-plugin</a></li><li>Intel all Device Plugin: <a href=https://github.com/intel/intel-device-plugins-for-kubernetes>https://github.com/intel/intel-device-plugins-for-kubernetes</a></li><li>AMD Device Plugin: <a href=https://github.com/RadeonOpenCompute/k8s-device-plugin>https://github.com/RadeonOpenCompute/k8s-device-plugin</a></li></ul><p>其他的 Smart NIC 或 InfiniBand 高性能设备厂商也提供了 Device Plugin 方案。</p><h1 id=kubernetes-上的-device-plugin-实现>Kubernetes 上的 Device Plugin 实现</h1><p>Device Plugin 的实现在 <code>pkg/kubelet/cm/devicemanager/</code> 下面，对于 Kubelet 来说，入口在 manager.go 文件中：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span># tree | grep -Ev &#34;*test*&#34; 的执行结果
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── OWNERS
</span></span><span style=display:flex><span>├── checkpoint
</span></span><span style=display:flex><span>│   ├── checkpoint.go
</span></span><span style=display:flex><span>│   └── checkpointv1.go
</span></span><span style=display:flex><span>├── endpoint.go
</span></span><span style=display:flex><span>├── manager.go
</span></span><span style=display:flex><span>├── plugin
</span></span><span style=display:flex><span>│   └── v1beta1
</span></span><span style=display:flex><span>│       ├── api.go
</span></span><span style=display:flex><span>│       ├── client.go
</span></span><span style=display:flex><span>│       ├── handler.go
</span></span><span style=display:flex><span>│       ├── server.go
</span></span><span style=display:flex><span>│       └── stub.go
</span></span><span style=display:flex><span>├── pod_devices.go
</span></span><span style=display:flex><span>├── topology_hints.go
</span></span><span style=display:flex><span>└── types.go
</span></span></code></pre></td></tr></table></div></div><p>types.go 中主要内容是 DeviceRunContainerOptions 和 Manager。前者是个结构体，后者是个接口。
DeviceRunContainerOptions 包含组合容器运行时设置以使用其分配的设备。Manager 管理节点上运行的所有 Device Plugin：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> Manager <span style=color:#ff5c57>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#78787e>// Start 启动 Device Plugin 注册服务。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>Start</span>(activePods ActivePodsFunc, sourcesReady config.SourcesReady, initialContainers containermap.ContainerMap, initialContainerRunningSet sets.String) <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// Allocate 配置和为容器中的一个 Pod 分配设备。通过请求的设备资源，
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#78787e>// Allocate 将与所属的设备插件进行通信，以便进行设置流程，并由设备插件提供运行时设置以使用设备（环境变量，挂载点和设备文件）。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>Allocate</span>(pod <span style=color:#ff6ac1>*</span>v1.Pod, container <span style=color:#ff6ac1>*</span>v1.Container) <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// UpdatePluginResources 根据已经分配给 Pod 的设备更新节点资源。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#78787e>// 节点对象由设备管理器提供，用于更新节点容量以反映当前可用的设备。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>UpdatePluginResources</span>(node <span style=color:#ff6ac1>*</span>schedulerframework.NodeInfo, attrs <span style=color:#ff6ac1>*</span>lifecycle.PodAdmitAttributes) <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// Stop 停止管理器
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>Stop</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// GetDeviceRunContainerOptions 检查我们是否具有为传入的 &lt;pod, container&gt; 缓存的 containerDevices，并返回其找到的 DeviceRunContainerOptions。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#78787e>// 如果未找到缓存的状态，则返回空结构体。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>GetDeviceRunContainerOptions</span>(pod <span style=color:#ff6ac1>*</span>v1.Pod, container <span style=color:#ff6ac1>*</span>v1.Container) (<span style=color:#ff6ac1>*</span>DeviceRunContainerOptions, <span style=color:#9aedfe>error</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// GetCapacity 返回节点上注册的 Device Plugin 资源的可用容量、可分配资源和非活动 Device Plugin 资源的数量。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>GetCapacity</span>() (v1.ResourceList, v1.ResourceList, []<span style=color:#9aedfe>string</span>)
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>GetWatcherHandler</span>() cache.PluginHandler
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// GetDevices 返回分配给Pod和容器的设备信息
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>GetDevices</span>(podUID, containerName <span style=color:#9aedfe>string</span>) ResourceDeviceInstances
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// GetAllocatableDevices 返回有关所有已知设备的信息给管理器
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>GetAllocatableDevices</span>() ResourceDeviceInstances
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// ShouldResetExtendedResourceCapacity 根据检查点文件的可用性，返回是否应该重置 Extended Resource 的信息。缺少检查点文件强烈暗示节点已被重建。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>ShouldResetExtendedResourceCapacity</span>() <span style=color:#9aedfe>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// TopologyManager HintProvider 提供者表示设备管理器实现了 TopologyManager 接口，并且被用于使拓扑感知资源对齐。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>GetTopologyHints</span>(pod <span style=color:#ff6ac1>*</span>v1.Pod, container <span style=color:#ff6ac1>*</span>v1.Container) <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>][]topologymanager.TopologyHint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// TopologyManager HintProvider 提供者指示设备管理器实现了 TopologyManager 接口，并在每个 Pod 上进行资源对齐以使拓扑感知。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>GetPodTopologyHints</span>(pod <span style=color:#ff6ac1>*</span>v1.Pod) <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>][]topologymanager.TopologyHint
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// UpdateAllocatedDevices 释放绑定到已终止的 Pod 的任何设备。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#57c7ff>UpdateAllocatedDevices</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>Manager 接口主要被 manager.go 中的 ManagerImpl 结构体实现。ManagerImpl 的实例被 NewManagerImpl() 函数创建。
NewManagerImpl() 函数的唯一用途就是判断系统平台以确定合适的 Unix Socket 文件位置（例如：<code>/var/lib/kubelet/device-plugins/kubelet.sock</code>），然后传递给 newManagerImpl() 这个内部函数。newManagerImpl() 函数创建了 ManagerImpl 的实例：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>newManagerImpl</span>(socketPath <span style=color:#9aedfe>string</span>, topology []cadvisorapi.Node, topologyAffinityStore topologymanager.Store) (<span style=color:#ff6ac1>*</span>ManagerImpl, <span style=color:#9aedfe>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	manager <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>&amp;</span>ManagerImpl{
</span></span><span style=display:flex><span>		endpoints: <span style=color:#ff5c57>make</span>(<span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]endpointInfo),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		allDevices:            <span style=color:#57c7ff>NewResourceDeviceInstances</span>(),
</span></span><span style=display:flex><span>		healthyDevices:        <span style=color:#ff5c57>make</span>(<span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]sets.String),
</span></span><span style=display:flex><span>		unhealthyDevices:      <span style=color:#ff5c57>make</span>(<span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]sets.String),
</span></span><span style=display:flex><span>		allocatedDevices:      <span style=color:#ff5c57>make</span>(<span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]sets.String),
</span></span><span style=display:flex><span>		podDevices:            <span style=color:#57c7ff>newPodDevices</span>(),
</span></span><span style=display:flex><span>		numaNodes:             numaNodes,
</span></span><span style=display:flex><span>		topologyAffinityStore: topologyAffinityStore,
</span></span><span style=display:flex><span>		devicesToReuse:        <span style=color:#ff5c57>make</span>(PodReusableDevices),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	server, err <span style=color:#ff6ac1>:=</span> plugin.<span style=color:#57c7ff>NewServer</span>(socketPath, manager, manager)
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	manager.server = server
</span></span><span style=display:flex><span>	manager.checkpointdir, _ = filepath.<span style=color:#57c7ff>Split</span>(server.<span style=color:#57c7ff>SocketPath</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// The following structures are populated with real implementations in manager.Start()
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#78787e>// Before that, initializes them to perform no-op operations.
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	manager.activePods = <span style=color:#ff5c57>func</span>() []<span style=color:#ff6ac1>*</span>v1.Pod { <span style=color:#ff6ac1>return</span> []<span style=color:#ff6ac1>*</span>v1.Pod{} }
</span></span><span style=display:flex><span>	manager.sourcesReady = <span style=color:#ff6ac1>&amp;</span>sourcesReadyStub{}
</span></span><span style=display:flex><span>	checkpointManager, err <span style=color:#ff6ac1>:=</span> checkpointmanager.<span style=color:#57c7ff>NewCheckpointManager</span>(manager.checkpointdir)
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span>, fmt.<span style=color:#57c7ff>Errorf</span>(<span style=color:#5af78e>&#34;failed to initialize checkpoint manager: %v&#34;</span>, err)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	manager.checkpointManager = checkpointManager
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> manager, <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>在上面的代码中，NewServer() 返回一个初始化的 Device Plugin 注册服务器。此外，newManagerImpl() 函数还创建了 CheckPointManager。</p><p>Device Plugin 与 Device Plugin Manager 的交互逻辑在 <code>vendor/k8s.io/kubelet/pkg/apis/deviceplugin/v1beta1/api.proto</code> 中定义，主要有以下几个 Service：</p><ul><li>Registration：只有一个 Register 方法。</li><li>DevicePlugin：GetDevicePluginOptions，ListAndWatch，GetPreferredAllocation，Allocate，PreStartContainer。重点关注 ListAndWatch 和 Allocate。</li></ul><p>这个 Proto 的定义实现在 <code>api.pb.go</code> 文件中，<code>constant.go</code> 定义了一些常量。这些 API 在 <code>plugin/v1beta1/stub.go</code> 中导入：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff6ac1>import</span> pluginapi <span style=color:#5af78e>&#34;k8s.io/kubelet/pkg/apis/deviceplugin/v1beta1&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>所有的请求被挂载到 Stub 结构体上。接下来我们看看 Stub.Register() 方法的实现：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#78787e>// Register 将 Device Plugin 与指定的资源名称在Kubelet中注册。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>func</span> (m <span style=color:#ff6ac1>*</span>Stub) <span style=color:#57c7ff>Register</span>(kubeletEndpoint, resourceName <span style=color:#9aedfe>string</span>, pluginSockDir <span style=color:#9aedfe>string</span>) <span style=color:#9aedfe>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	conn, err <span style=color:#ff6ac1>:=</span> grpc.<span style=color:#57c7ff>DialContext</span>(ctx, kubeletEndpoint,
</span></span><span style=display:flex><span>		grpc.<span style=color:#57c7ff>WithTransportCredentials</span>(insecure.<span style=color:#57c7ff>NewCredentials</span>()),
</span></span><span style=display:flex><span>		grpc.<span style=color:#57c7ff>WithBlock</span>(),
</span></span><span style=display:flex><span>		grpc.<span style=color:#57c7ff>WithContextDialer</span>(<span style=color:#ff5c57>func</span>(ctx context.Context, addr <span style=color:#9aedfe>string</span>) (net.Conn, <span style=color:#9aedfe>error</span>) {
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>return</span> (<span style=color:#ff6ac1>&amp;</span>net.Dialer{}).<span style=color:#57c7ff>DialContext</span>(ctx, <span style=color:#5af78e>&#34;unix&#34;</span>, addr)
</span></span><span style=display:flex><span>		}))
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>return</span> err
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>defer</span> conn.<span style=color:#57c7ff>Close</span>()
</span></span><span style=display:flex><span>	client <span style=color:#ff6ac1>:=</span> pluginapi.<span style=color:#57c7ff>NewRegistrationClient</span>(conn)
</span></span><span style=display:flex><span>	reqt <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>&amp;</span>pluginapi.RegisterRequest{
</span></span><span style=display:flex><span>		Version:      pluginapi.Version,
</span></span><span style=display:flex><span>		Endpoint:     filepath.<span style=color:#57c7ff>Base</span>(m.socket),
</span></span><span style=display:flex><span>		ResourceName: resourceName,
</span></span><span style=display:flex><span>		Options: <span style=color:#ff6ac1>&amp;</span>pluginapi.DevicePluginOptions{
</span></span><span style=display:flex><span>			PreStartRequired:                m.preStartContainerFlag,
</span></span><span style=display:flex><span>			GetPreferredAllocationAvailable: m.getPreferredAllocationFlag,
</span></span><span style=display:flex><span>		},
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	_, err = client.<span style=color:#57c7ff>Register</span>(context.<span style=color:#57c7ff>Background</span>(), reqt)
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> err
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个函数的主要逻辑是创建一个客户端对象，然后调用 Register() 方法，使用 Context 库进行超时控制。对于 ListAndWatch 和 Allocate 也都是同理：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#78787e>// ListAndWatch 根据更新调用列出设备并更新该列表。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>func</span> (m <span style=color:#ff6ac1>*</span>Stub) <span style=color:#57c7ff>ListAndWatch</span>(e <span style=color:#ff6ac1>*</span>pluginapi.Empty, s pluginapi.DevicePlugin_ListAndWatchServer) <span style=color:#9aedfe>error</span> {
</span></span><span style=display:flex><span>	klog.<span style=color:#57c7ff>InfoS</span>(<span style=color:#5af78e>&#34;ListAndWatch&#34;</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	s.<span style=color:#57c7ff>Send</span>(<span style=color:#ff6ac1>&amp;</span>pluginapi.ListAndWatchResponse{Devices: m.devs})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>for</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>select</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>case</span> <span style=color:#ff6ac1>&lt;-</span>m.stop:
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>case</span> updated <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>&lt;-</span>m.update:
</span></span><span style=display:flex><span>			s.<span style=color:#57c7ff>Send</span>(<span style=color:#ff6ac1>&amp;</span>pluginapi.ListAndWatchResponse{Devices: updated})
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#78787e>// Allocate 进行模拟分配
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>func</span> (m <span style=color:#ff6ac1>*</span>Stub) <span style=color:#57c7ff>Allocate</span>(ctx context.Context, r <span style=color:#ff6ac1>*</span>pluginapi.AllocateRequest) (<span style=color:#ff6ac1>*</span>pluginapi.AllocateResponse, <span style=color:#9aedfe>error</span>) {
</span></span><span style=display:flex><span>	klog.<span style=color:#57c7ff>InfoS</span>(<span style=color:#5af78e>&#34;Allocate&#34;</span>, <span style=color:#5af78e>&#34;request&#34;</span>, r)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	devs <span style=color:#ff6ac1>:=</span> <span style=color:#ff5c57>make</span>(<span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]pluginapi.Device)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>for</span> _, dev <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>range</span> m.devs {
</span></span><span style=display:flex><span>		devs[dev.ID] = <span style=color:#ff6ac1>*</span>dev
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> m.<span style=color:#57c7ff>allocFunc</span>(r, devs)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>plugin/v1beta1/server.go</code> 文件主要是通过 Start() 方法启动一个 gRPC Server：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> Server <span style=color:#ff5c57>interface</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>type</span> server <span style=color:#ff5c57>struct</span> {
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>NewServer</span>(socketPath <span style=color:#9aedfe>string</span>, rh RegistrationHandler, ch ClientHandler) (Server, <span style=color:#9aedfe>error</span>) {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	s <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>&amp;</span>server{
</span></span><span style=display:flex><span>		socketName: name,
</span></span><span style=display:flex><span>		socketDir:  dir,
</span></span><span style=display:flex><span>		rhandler:   rh,
</span></span><span style=display:flex><span>		chandler:   ch,
</span></span><span style=display:flex><span>		clients:    <span style=color:#ff5c57>make</span>(<span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]Client),
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> s, <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> (s <span style=color:#ff6ac1>*</span>server) <span style=color:#57c7ff>Start</span>() <span style=color:#9aedfe>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	s.grpc = grpc.<span style=color:#57c7ff>NewServer</span>([]grpc.ServerOption{}<span style=color:#ff6ac1>...</span>)
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>plugin/v1beta1/handler.go</code> 文件为 Server 对象挂载了许多方法。<code>plugin/v1beta1/client.go</code> 文件核心在于两个接口：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#78787e>// DevicePlugin 接口提供了访问 Device Plugin 资源、API和UNIX套接字的方法。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>type</span> DevicePlugin <span style=color:#ff5c57>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>API</span>() api.DevicePluginClient
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>Resource</span>() <span style=color:#9aedfe>string</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>SocketPath</span>() <span style=color:#9aedfe>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e>// Client 接口提供了建立/关闭 gRPC 连接以及运行 Device Plugin gRPC 客户端的方法。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>type</span> Client <span style=color:#ff5c57>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>Connect</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>Run</span>()
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>Disconnect</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>客户端通过 Connect() 方法连接后便持有一个 gRPC 客户端对象，通过 Run() 方法调用了 ListAndWatch() 方法发送 gRPC 请求获取资源：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> (c <span style=color:#ff6ac1>*</span>client) <span style=color:#57c7ff>Run</span>() {
</span></span><span style=display:flex><span>	stream, err <span style=color:#ff6ac1>:=</span> c.client.<span style=color:#57c7ff>ListAndWatch</span>(context.<span style=color:#57c7ff>Background</span>(), <span style=color:#ff6ac1>&amp;</span>api.Empty{})
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>for</span> {
</span></span><span style=display:flex><span>		response, err <span style=color:#ff6ac1>:=</span> stream.<span style=color:#57c7ff>Recv</span>()
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>		c.handler.<span style=color:#57c7ff>PluginListAndWatchReceiver</span>(c.resource, response)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>通过调用 Resource() 方法就可以获取资源了。当 Run() 方法被调用后其实就进入了一个死循环，一直在 gRPC 的 Stream 中获取 Device Plugin 的数据，从 Protobuf 文件的定义来看也是如此：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-protobuf data-lang=protobuf><span style=display:flex><span><span style=color:#ff6ac1>rpc</span> ListAndWatch(Empty) <span style=color:#ff6ac1>returns</span> (stream ListAndWatchResponse) {}<span style=color:#ff5c57>
</span></span></span></code></pre></td></tr></table></div></div><p>总结一句话就是 Device Plugin 启动后会与 Device Plugin Manager 以 Unix Socket 承载 gRPC Stream 的方式执行 ListAndWatch 实时发生数据交换。</p><p>思路再回到 ManagerImpl 这个结构体上，ManagerImpl 持有了不少的数据：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#78787e>// ManagerImpl is the structure in charge of managing Device Plugins.
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>type</span> ManagerImpl <span style=color:#ff5c57>struct</span> {
</span></span><span style=display:flex><span>	checkpointdir <span style=color:#9aedfe>string</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	endpoints <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]endpointInfo <span style=color:#78787e>// Key 是 ResourceName
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	mutex     sync.Mutex
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	server plugin.Server
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// activePods 是一个用于列出节点上活动 Pod 的方法，因此在更新分配的设备时可以统计现有 Pod 请求的 DevicePlugin 的数量。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	activePods ActivePodsFunc
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// sourcesReady 提供了 kubelet 配置来源的准备情况，比如 API Server 的更新准备情况。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#78787e>// 我们使用它来确定何时可以从检查点状态中清除未使用的pod。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	sourcesReady config.SourcesReady
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// allDevices 保存了当前注册到设备管理器的所有设备。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	allDevices ResourceDeviceInstances
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// healthyDevices 包含所有注册的健康资源名称及其导出的设备ID。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	healthyDevices <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]sets.String
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// unhealthyDevices 包含所有不健康的设备及其导出的设备ID。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	unhealthyDevices <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]sets.String
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// allocatedDevices 包含按资源名称键入的已分配设备ID。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	allocatedDevices <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]sets.String
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// podDevices 包含了 Pod 到分配设备的映射。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	podDevices        <span style=color:#ff6ac1>*</span>podDevices
</span></span><span style=display:flex><span>	checkpointManager checkpointmanager.CheckpointManager
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// 底层机器上可用的NUMA节点列表
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	numaNodes []<span style=color:#9aedfe>int</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// 拓扑亲和性存储，设备管理器可查询。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	topologyAffinityStore topologymanager.Store
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// devicesToReuse 包含可重复使用的设备，因为它们已经被分配给 init 容器
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	devicesToReuse PodReusableDevices
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// pendingAdmissionPod 在 Admission 阶段包含了该Pod
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	pendingAdmissionPod <span style=color:#ff6ac1>*</span>v1.Pod
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// containerMap为每个pod中的所有容器提供了从 (pod, container) -&gt; containerID 的映射。用于检测在重新启动后运行的 Pod。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	containerMap containermap.ContainerMap
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// containerRunningSet 标识在计算 containerMap 时，容器运行时报告的正在运行的容器中的哪个容器。用于检测在重启时正在运行的 Pod。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	containerRunningSet sets.String
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>podDevices 本质是通过读写锁实现的并发安全的 Map：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> podDevices <span style=color:#ff5c57>struct</span> {
</span></span><span style=display:flex><span>	sync.RWMutex
</span></span><span style=display:flex><span>	devs <span style=color:#ff5c57>map</span>[<span style=color:#9aedfe>string</span>]containerDevices <span style=color:#78787e>// Keyed by podUID.
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>}
</span></span></code></pre></td></tr></table></div></div><p>我们在这个小结了解了 Device Plugin 在 Kubelet 层面的实现，接下来看看第三方厂商视角下的 Device Plugin。</p><h1 id=从-mellanox-rdma-的-device-plugin-学习>从 Mellanox RDMA 的 Device Plugin 学习</h1><p>Mellanox Technologies（纳斯达克： MLNX ）是一家在全球范围内为服务器和存储提供端到端Infiniband和以太网互联解决方案的领军企业。
Mellanox 互连解决方案通过低延迟、高吞吐量的强大性能，可以极大的提升数据中心效率，在应用和系统之间快速的传递数据。</p><blockquote><p>InfiniBand是一种网络通信协议，它在处理器节点之间以及处理器节点和输入/输出节点（如磁盘或存储器）之间提供基于交换机的点到点双向串行链路结构（Fabric）。</p><p>InfiniBand通过交换机在节点之间直接创建一个专用的受保护通道，并通过InfiniBand适配器管理和执行的远程直接内存访问（RDMA）和发送/接收卸载，方便了数据和消息的移动。 InfiniBand技术包括 SRD、DDR、QDR、FDR、EDR、HDR 和NDR等多种数据传输速率。InfiniBand最重要的一个特点就是高带宽、低延迟，应用于计算机与计算机之间的数据互连。</p></blockquote><p>以上是 Microsoft Bing Chat 对Mellanox的介绍。Mellanox 提供了两种 Device Plugin，一种是 k8s-rdma-sriov-dev-plugin，已经过时；还有一种是 <a href=https://github.com/mellanox/k8s-rdma-shared-dev-plugin>k8s-rdma-shared-dev-plugin</a>。</p><p>我们将代码 Clone 到本地，然后使用 Goland 打开：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git clone https://github.com/Mellanox/k8s-rdma-shared-dev-plugin.git
</span></span><span style=display:flex><span><span style=color:#ff5c57>cd</span> k8s-rdma-shared-dev-plugin
</span></span><span style=display:flex><span>go mod download
</span></span></code></pre></td></tr></table></div></div><p>单纯去实现 Device Plugin 是比较简单的，难的是让 Kubernetes 具备宏观调度能力，而不是局限到某个 Node 视角上。项目结构如下：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#78787e># tree | grep -Ev &#34;*test*&#34; 的执行结果</span>
</span></span><span style=display:flex><span>.
</span></span><span style=display:flex><span>├── Dockerfile
</span></span><span style=display:flex><span>├── Dockerfile.ubi
</span></span><span style=display:flex><span>├── LICENSE
</span></span><span style=display:flex><span>├── Makefile
</span></span><span style=display:flex><span>├── README.md
</span></span><span style=display:flex><span>├── cmd
</span></span><span style=display:flex><span>│   └── k8s-rdma-shared-dp
</span></span><span style=display:flex><span>│       └── main.go
</span></span><span style=display:flex><span>├── example
</span></span><span style=display:flex><span>├── go.mod
</span></span><span style=display:flex><span>├── go.sum
</span></span><span style=display:flex><span>├── images
</span></span><span style=display:flex><span>│   ├── k8s-rdma-shared-dev-plugin-config-map.yaml
</span></span><span style=display:flex><span>│   ├── k8s-rdma-shared-dev-plugin-ds-pre-1.16.yaml
</span></span><span style=display:flex><span>│   └── k8s-rdma-shared-dev-plugin-ds.yaml
</span></span><span style=display:flex><span>├── pkg
</span></span><span style=display:flex><span>│   ├── resources
</span></span><span style=display:flex><span>│   │   ├── device_selectors.go
</span></span><span style=display:flex><span>│   │   ├── netlink_manager.go
</span></span><span style=display:flex><span>│   │   ├── pci_net_device.go
</span></span><span style=display:flex><span>│   │   ├── rdma_device_spec.go
</span></span><span style=display:flex><span>│   │   ├── resources_manager.go
</span></span><span style=display:flex><span>│   │   ├── server.go
</span></span><span style=display:flex><span>│   │   ├── watcher.go
</span></span><span style=display:flex><span>│   ├── types
</span></span><span style=display:flex><span>│   │   ├── mocks
</span></span><span style=display:flex><span>│   │   │   ├── NetlinkManager.go
</span></span><span style=display:flex><span>│   │   │   ├── PciNetDevice.go
</span></span><span style=display:flex><span>│   │   │   ├── RdmaDeviceSpec.go
</span></span><span style=display:flex><span>│   │   │   ├── ResourceServer.go
</span></span><span style=display:flex><span>│   │   │   └── ResourceServerConnector.go
</span></span><span style=display:flex><span>│   │   └── types.go
</span></span><span style=display:flex><span>│   └── utils
</span></span><span style=display:flex><span>│       └── utils.go
</span></span><span style=display:flex><span>└── scripts
</span></span><span style=display:flex><span>    └── deploy.sh
</span></span></code></pre></td></tr></table></div></div><p>我们可以观察到二进制文件的入口就是 <code>cmd/k8s-rdma-shared-dp/main.go</code> 文件，主要函数就是 main() 函数，简化后的内容为：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	rm <span style=color:#ff6ac1>:=</span> resources.<span style=color:#57c7ff>NewResourceManager</span>()
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>ValidateConfigs</span>(); err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>ValidateRdmaSystemMode</span>(); err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>DiscoverHostDevices</span>(); err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>InitServers</span>(); err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>StartAllServers</span>(); err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	stopPeriodicUpdate <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>PeriodicUpdate</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	signalsNotifier <span style=color:#ff6ac1>:=</span> resources.<span style=color:#57c7ff>NewSignalNotifier</span>(syscall.SIGHUP, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT)
</span></span><span style=display:flex><span>	sigs <span style=color:#ff6ac1>:=</span> signalsNotifier.<span style=color:#57c7ff>Notify</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	s <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>&lt;-</span>sigs
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>switch</span> s {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>case</span> syscall.SIGHUP:
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>RestartAllServers</span>(); err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>default</span>:
</span></span><span style=display:flex><span>		<span style=color:#57c7ff>stopPeriodicUpdate</span>()
</span></span><span style=display:flex><span>		_ = rm.<span style=color:#57c7ff>StopAllServers</span>()
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>return</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>我们来一一分析 main() 函数中主要做了什么事情。首先通过 NewResourceManager() 工厂函数创建了一个 ResourceManager 对象，它持有这些数据：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> resourceManager <span style=color:#ff5c57>struct</span> {
</span></span><span style=display:flex><span>	configFile             <span style=color:#9aedfe>string</span>
</span></span><span style=display:flex><span>	defaultResourcePrefix  <span style=color:#9aedfe>string</span>
</span></span><span style=display:flex><span>	socketSuffix           <span style=color:#9aedfe>string</span>
</span></span><span style=display:flex><span>	watchMode              <span style=color:#9aedfe>bool</span>
</span></span><span style=display:flex><span>	configList             []<span style=color:#ff6ac1>*</span>types.UserConfig
</span></span><span style=display:flex><span>	resourceServers        []types.ResourceServer
</span></span><span style=display:flex><span>	deviceList             []<span style=color:#ff6ac1>*</span>ghw.PCIDevice
</span></span><span style=display:flex><span>	netlinkManager         types.NetlinkManager
</span></span><span style=display:flex><span>	rds                    types.RdmaDeviceSpec
</span></span><span style=display:flex><span>	PeriodicUpdateInterval time.Duration
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个结构体上有以下这些方法：</p><ul><li><code>ReadConfig()</code>：读取配置</li><li><code>ValidateConfigs()</code>：验证配置</li><li><code>ValidateRdmaSystemMode()</code>：确保RDMA子系统网络命名空间模式是共享的</li><li><code>InitServers()</code>：初始化服务器</li><li><code>StartAllServers()</code>：启动全部的服务器</li><li><code>StopAllServers()</code>：停止全部的服务器</li><li><code>RestartAllServers()</code>：重启全部的服务器</li><li><code>DiscoverHostDevices()</code>：发现主机设备</li><li><code>GetDevices()</code>：获取设备</li><li><code>GetFilteredDevices()</code>：获取被过滤的设备</li><li><code>PeriodicUpdate()</code>：定期更新</li></ul><p>这些方法都在 <code>pkg/types.go</code> 中进行了描述：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#78787e>// ResourceManager manger multi plugins
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>type</span> ResourceManager <span style=color:#ff5c57>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>ReadConfig</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>ValidateConfigs</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>ValidateRdmaSystemMode</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>DiscoverHostDevices</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>GetDevices</span>() []PciNetDevice
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>InitServers</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>StartAllServers</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>StopAllServers</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>RestartAllServers</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>GetFilteredDevices</span>(devices []PciNetDevice, selector <span style=color:#ff6ac1>*</span>Selectors) []PciNetDevice
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>PeriodicUpdate</span>() <span style=color:#ff5c57>func</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>所有 resourceManager 实际上是 ResourceManager 接口的实现类，上面列出的方法会被 main() 函数逐一调用。</p><p>首先是通过 ReadConfig() 方法读取配置后传递给 ValidateConfigs() 方法进行验证，如果验证失败就会抛出错误日志。
ValidateRdmaSystemMode() 方法调用了 RdmaSystemGetNetnsMode() 方法，这个方法来自 <code>"github.com/vishvananda/netlink</code> 包，我们先不去管具体做了什么事情。
接下来是 DiscoverHostDevices() 方法被调用，应该是枚举 PCIe 总线上的设备并添加到 ResourceManager 上：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> (rm <span style=color:#ff6ac1>*</span>resourceManager) <span style=color:#57c7ff>DiscoverHostDevices</span>() <span style=color:#9aedfe>error</span> {
</span></span><span style=display:flex><span>	pci, err <span style=color:#ff6ac1>:=</span> ghw.<span style=color:#57c7ff>PCI</span>()
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	devices <span style=color:#ff6ac1>:=</span> pci.<span style=color:#57c7ff>ListDevices</span>()
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> <span style=color:#ff5c57>len</span>(devices) <span style=color:#ff6ac1>==</span> <span style=color:#ff9f43>0</span> {
</span></span><span style=display:flex><span>		log.<span style=color:#57c7ff>Println</span>(<span style=color:#5af78e>&#34;Warning: DiscoverHostDevices(): no PCI network device found&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	rm.deviceList = []<span style=color:#ff6ac1>*</span>ghw.PCIDevice{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>for</span> _, device <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>range</span> devices {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>		rm.deviceList = <span style=color:#ff5c57>append</span>(rm.deviceList, device)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>然后紧接着就调用了 InitServers() 进行服务器初始化操作，核心在于通过 newResourceServer() 方法创建资源服务器：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> (rm <span style=color:#ff6ac1>*</span>resourceManager) <span style=color:#57c7ff>InitServers</span>() <span style=color:#9aedfe>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>for</span> _, config <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>range</span> rm.configList {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>		rs, err <span style=color:#ff6ac1>:=</span> <span style=color:#57c7ff>newResourceServer</span>(config, filteredDevices, rm.watchMode, rm.socketSuffix)
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>return</span> err
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		rm.resourceServers = <span style=color:#ff5c57>append</span>(rm.resourceServers, rs)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>newResourceServer() 方法是 resourceServer 结构体的工厂函数，resourceServer 实现了 <code>pkg/types/types.go</code> 中的 ResourceServer 接口：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#78787e>// ResourceServer is gRPC server implements K8s device plugin api
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>type</span> ResourceServer <span style=color:#ff5c57>interface</span> {
</span></span><span style=display:flex><span>	pluginapi.DevicePluginServer
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>Start</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>Stop</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>Restart</span>() <span style=color:#9aedfe>error</span>
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>Watch</span>()
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>UpdateDevices</span>([]PciNetDevice)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>ResourceServer 是一个 gRPC 服务器，实现了 Kubbernetes 的 Device Plugin API，也就是 <code>pkg/apis/deviceplugin/v1beta1/api.pb.go</code> 定义的内容。
初始化完成之后就是调用 StartAllServers() 方法启动服务器了，调用了 resourceServers 的 Start() 方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> (rm <span style=color:#ff6ac1>*</span>resourceManager) <span style=color:#57c7ff>StartAllServers</span>() <span style=color:#9aedfe>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>for</span> _, rs <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>range</span> rm.resourceServers {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>:=</span> rs.<span style=color:#57c7ff>Start</span>(); err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>return</span> err
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#78787e>// start watcher
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>		<span style=color:#ff6ac1>if</span> !rm.watchMode {
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>go</span> rs.<span style=color:#57c7ff>Watch</span>()
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>这个 Start() 方法刚好就是 Device Plugin API 提供的 Start() 方法。启动好全部的 gRPC 服务器之后，就是调用 PeriodicUpdate() 方法。这个方法的作用是 “定期更新”，我们来看看定期更新些什么内容：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> (rm <span style=color:#ff6ac1>*</span>resourceManager) <span style=color:#57c7ff>PeriodicUpdate</span>() <span style=color:#ff5c57>func</span>() {
</span></span><span style=display:flex><span>	stopChan <span style=color:#ff6ac1>:=</span> <span style=color:#ff5c57>make</span>(<span style=color:#ff5c57>chan</span> <span style=color:#ff5c57>interface</span>{})
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> rm.PeriodicUpdateInterval &gt; <span style=color:#ff9f43>0</span> {
</span></span><span style=display:flex><span>		ticker <span style=color:#ff6ac1>:=</span> time.<span style=color:#57c7ff>NewTicker</span>(rm.PeriodicUpdateInterval)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#78787e>// Listen for update or stop update channels
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>		<span style=color:#ff6ac1>go</span> <span style=color:#ff5c57>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>for</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff6ac1>select</span> {
</span></span><span style=display:flex><span>				<span style=color:#ff6ac1>case</span> <span style=color:#ff6ac1>&lt;-</span>ticker.C:
</span></span><span style=display:flex><span>					<span style=color:#ff6ac1>if</span> err <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>DiscoverHostDevices</span>(); err <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>						log.<span style=color:#57c7ff>Printf</span>(<span style=color:#5af78e>&#34;error: failed to discover host devices: %v&#34;</span>, err)
</span></span><span style=display:flex><span>						<span style=color:#ff6ac1>continue</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>					<span style=color:#ff6ac1>for</span> index, rs <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>range</span> rm.resourceServers {
</span></span><span style=display:flex><span>						devices <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>GetDevices</span>()
</span></span><span style=display:flex><span>						filteredDevices <span style=color:#ff6ac1>:=</span> rm.<span style=color:#57c7ff>GetFilteredDevices</span>(devices, <span style=color:#ff6ac1>&amp;</span>rm.configList[index].Selectors)
</span></span><span style=display:flex><span>						rs.<span style=color:#57c7ff>UpdateDevices</span>(filteredDevices)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				<span style=color:#ff6ac1>case</span> <span style=color:#ff6ac1>&lt;-</span>stopChan:
</span></span><span style=display:flex><span>					ticker.<span style=color:#57c7ff>Stop</span>()
</span></span><span style=display:flex><span>					<span style=color:#ff6ac1>return</span>
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#78787e>// Return stop function
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#ff6ac1>return</span> <span style=color:#ff5c57>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>if</span> rm.PeriodicUpdateInterval &gt; <span style=color:#ff9f43>0</span> {
</span></span><span style=display:flex><span>			stopChan <span style=color:#ff6ac1>&lt;-</span> <span style=color:#ff6ac1>true</span>
</span></span><span style=display:flex><span>			<span style=color:#ff5c57>close</span>(stopChan)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>原来是只要定时器不停止，就一直存在一个 Goroutine 不断的调用 ResourceManager 的 DiscoverHostDevices() 和 GetFilteredDevices() 方法，很明显了，是不断的枚举 PCIe 总线上的设备。
枚举完成后进行过滤找出符合要求的 PCIe 设备，调用 UpdateDevices() 方法进行更新：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> (rs <span style=color:#ff6ac1>*</span>resourceServer) <span style=color:#57c7ff>UpdateDevices</span>(devices []types.PciNetDevice) {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	<span style=color:#78787e>// Create devices list if not exists
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	<span style=color:#ff6ac1>if</span> <span style=color:#ff5c57>len</span>(rs.devs) <span style=color:#ff6ac1>==</span> <span style=color:#ff9f43>0</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff5c57>var</span> devs []<span style=color:#ff6ac1>*</span>pluginapi.Device
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>for</span> n <span style=color:#ff6ac1>:=</span> <span style=color:#ff9f43>0</span>; n &lt; rs.rdmaHcaMax; n<span style=color:#ff6ac1>++</span> {
</span></span><span style=display:flex><span>			id <span style=color:#ff6ac1>:=</span> n
</span></span><span style=display:flex><span>			dpDevice <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>&amp;</span>pluginapi.Device{
</span></span><span style=display:flex><span>				ID:     strconv.<span style=color:#57c7ff>Itoa</span>(id),
</span></span><span style=display:flex><span>				Health: pluginapi.Healthy,
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			devs = <span style=color:#ff5c57>append</span>(devs, dpDevice)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		rs.devs = devs
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>  <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>方法的核心在于创建了 pluginapi.Device 的 Slice，这刚好是 <code>api.pb.go</code> 定义的结构体类型。</p><p>这些都准备好以后就会通过 NewSignalNotifier() 方法监听信号：syscall.SIGHUP, syscall.SIGINT, syscall.SIGTERM, syscall.SIGQUIT，剩下的就是优雅退出机制了。我们发现 Device Plugin 的 DaemonSet 都是通过 pluginapi 包实现的，
执行 <code>grep -Rn "*pluginapi*" pkg/resources/server.go</code> 查看符号位置：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>39:     health         chan *pluginapi.Device
</span></span><span style=display:flex><span>44:     devs       <span style=color:#ff6ac1>[]</span>*pluginapi.Device
</span></span><span style=display:flex><span>45:     deviceSpec <span style=color:#ff6ac1>[]</span>*pluginapi.DeviceSpec
</span></span><span style=display:flex><span>78:func <span style=color:#ff6ac1>(</span>rsc *resourcesServerPort<span style=color:#ff6ac1>)</span> Register<span style=color:#ff6ac1>(</span>client pluginapi.RegistrationClient, reqt *pluginapi.RegisterRequest<span style=color:#ff6ac1>)</span> error <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>111:    var devs <span style=color:#ff6ac1>[]</span>*pluginapi.Device
</span></span><span style=display:flex><span>153:            health:         make<span style=color:#ff6ac1>(</span>chan *pluginapi.Device<span style=color:#ff6ac1>)</span>,
</span></span><span style=display:flex><span>283:func <span style=color:#ff6ac1>(</span>rs *resourceServer<span style=color:#ff6ac1>)</span> ListAndWatch<span style=color:#ff6ac1>(</span>e *pluginapi.Empty, s pluginapi.DevicePlugin_ListAndWatchServer<span style=color:#ff6ac1>)</span> error <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>313:func <span style=color:#ff6ac1>(</span>rs *resourceServer<span style=color:#ff6ac1>)</span> sendDevices<span style=color:#ff6ac1>(</span>resp *pluginapi.ListAndWatchResponse,
</span></span><span style=display:flex><span>329:func <span style=color:#ff6ac1>(</span>rs *resourceServer<span style=color:#ff6ac1>)</span> Allocate<span style=color:#ff6ac1>(</span>ctx context.Context, r *pluginapi.AllocateRequest<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>(</span>
</span></span><span style=display:flex><span>330:    *pluginapi.AllocateResponse, error<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>335:    ress :<span style=color:#ff6ac1>=</span> make<span style=color:#ff6ac1>([]</span>*pluginapi.ContainerAllocateResponse, len<span style=color:#ff6ac1>(</span>r.GetContainerRequests<span style=color:#ff6ac1>()))</span>
</span></span><span style=display:flex><span>352:func <span style=color:#ff6ac1>(</span>rs *resourceServer<span style=color:#ff6ac1>)</span> GetDevicePluginOptions<span style=color:#ff6ac1>(</span>context.Context, *pluginapi.Empty<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>(</span>
</span></span><span style=display:flex><span>353:    *pluginapi.DevicePluginOptions, error<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>360:func <span style=color:#ff6ac1>(</span>rs *resourceServer<span style=color:#ff6ac1>)</span> PreStartContainer<span style=color:#ff6ac1>(</span>context.Context, *pluginapi.PreStartContainerRequest<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>(</span>
</span></span><span style=display:flex><span>361:    *pluginapi.PreStartContainerResponse, error<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>423:            rs.devs <span style=color:#ff6ac1>=</span> <span style=color:#ff6ac1>[]</span>*pluginapi.Device<span style=color:#ff6ac1>{}</span>
</span></span><span style=display:flex><span>431:            var devs <span style=color:#ff6ac1>[]</span>*pluginapi.Device
</span></span><span style=display:flex><span>447:func devicesChanged<span style=color:#ff6ac1>(</span>deviceList, newDeviceList <span style=color:#ff6ac1>[]</span>*pluginapi.DeviceSpec<span style=color:#ff6ac1>)</span> bool <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>467:func getDevicesSpec<span style=color:#ff6ac1>(</span>devices <span style=color:#ff6ac1>[]</span>types.PciNetDevice<span style=color:#ff6ac1>)</span> <span style=color:#ff6ac1>[]</span>*pluginapi.DeviceSpec <span style=color:#ff6ac1>{</span>
</span></span><span style=display:flex><span>468:    devicesSpec :<span style=color:#ff6ac1>=</span> make<span style=color:#ff6ac1>([]</span>*pluginapi.DeviceSpec, 0<span style=color:#ff6ac1>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这就眼熟了，resourceServer 把 Plugin Device Protobuf 中定义的函数都实现了一遍。</p><p>至此，Kubernetes Device Plugin 和 Deivce Plugin 方案都看了一遍，其实 Device Plugin 最大的缺陷在于只能在 Node 视角去做调度而非集群视角。
笔者在使用 Device Plugin 的时候直接 fork 了 Kubernetes 仓库，对 ManagerImpl 的 Kubelet 源码进行了大量的修改，并且重新开发了 Device Plugin 来支持集群视角的调度。</p><p>无论那种调度方案，都避免不了资源碎片，只能看 Pod 中的任务是否可以细分，否则有的 GPU 或者 FPGA 设备确实会在短时间内空闲，其实本质和编程语言的垃圾回收一样的道理。</p></div></div><footer id=footer><div class=footer-inner><div><div style=font-weight:700;margin-bottom:15px>发布点</div><div><a href=https://bluemiaomiao.gitee.io>中国境内镜像</a></div><div><a href=https://bluemiaomiao.github.io>中国境外镜像</a></div></div><div><div style=font-weight:700;margin-bottom:15px>致力于开源</div><div><a href=https://bluemiaomiao.github.io/fastdfs-spring-boot-starter/>FastDFS SpringBoot Starter</a></div></div><div><div style=font-weight:700;margin-bottom:15px>友人帐</div><div><a href=https://debuginn.cn>DebugInn</a></div></div><div><div style=font-weight:700;margin-bottom:15px>其他有用链接</div></div></div></footer></body><script src=../../js/halo.js type=text/javascript></script></html>