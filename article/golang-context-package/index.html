<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Halo的主页 - Golang 的 context 包源码分析</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@500&display=swap" rel=stylesheet><link rel=stylesheet href=../../css/halo.css><link rel=stylesheet href=../../css/github-markdown.css><link rel=stylesheet href=../../css/github-markdown-light.css><link rel=stylesheet href=../../css/markdown-rewrite.css><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><style>body{display:flex;flex-direction:column;align-items:center}a{color:#5e5e5e;text-decoration:none}</style></head><body><div id=mob-warning>当前内容暂不适配移动端。<br>请使用桌面端查看。</div><div id=top style=width:0;height:0></div><div class=top-button><a href=#top style=text-decoration:none>Top</a></div><div id=toc>目<br>录</div><div id=header><div style=width:100%;display:flex;align-items:center;height:100%><div class=disable-select style=display:flex;justify-content:flex-end;font-size:14pt;font-weight:700;color:#555><div style=margin-right:35px></div><div><a style=color:#555;text-decoration:none href=../../>&lt;Halo的主页/></a></div></div><div style=flex:1;display:flex;justify-content:flex-end;font-size:14pt;font-weight:700;color:#555><div style=margin-right:45px><a href=../../article style=color:#555;text-decoration:none>文章</a></div><div style=margin-right:45px><a href=../../video style=color:#555;text-decoration:none>视频</a></div><div style=margin-right:45px><a href=../../about style=color:#555;text-decoration:none>关于</a></div><div style=margin-left:35px></div></div></div></div><div id=article-content><div class=content-header><div>《Golang 的 context 包源码分析》</div><div style=font-size:10pt;height:100%;display:flex;align-items:flex-end;padding-bottom:12pt;color:#5e5e5e;font-weight:lighter>在2021/12/19 01:00:50更新，大约共1000字。</div></div><div class=content-desc><div style=font-size:50pt;font-weight:700;color:#eee;padding-right:15px>“</div><div style=line-height:50pt;color:#9b9b9b>[迁移] 一个只有400多行代码的常用包</div><div style=font-size:50pt;font-weight:700;color:#eee;padding-left:15px>”</div></div><div class="content-area markdown-body"><p>本文将会详细分析 <code>context</code> 这个包，Go 语言几乎是伴随着 Kubernetes 而知名，Kubernetes 正是云原生的明星框架。
云原生意味着需要大量的线程处理 I/O 请求。Go 语言正好提供了强大的 I/O 处理能力，并且还简化了编程模型。
在 Go 处理 I/O 任务时，往往一个任务关联更多的任务，典型的场景就是 Web API，通常一个 API 下可能包含多个中间件和其他 API
的连接。因此使用抽象的方式对这些 I/O 任务进行控制变得尤为重要。</p><p><img src=../../article/golang-context-package/context-tree.svg alt></p><p><strong>Context 中的 Event 具有传播行为，当前 Context 发生的 Event 会传播给全部的子节点。</strong></p><h1 id=context>Context</h1><p><code>context</code> 库使用树的结构描述多个任务之间的关系，在代码中通常体现为 <code>context</code> 类型的变量作为函数或者方法参数传递。
<code>context</code> 库定义了一个 <code>Context</code> 的接口，包含了我们常用的方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> Context <span style=color:#ff5c57>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#57c7ff>Deadline</span>() (deadline time.Time, ok <span style=color:#9aedfe>bool</span>) <span style=color:#78787e>// 返回 deadline，是截止日期，表示任务的完成时间
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#57c7ff>Done</span>() <span style=color:#ff6ac1>&lt;-</span><span style=color:#ff5c57>chan</span> <span style=color:#ff5c57>struct</span>{} <span style=color:#78787e>// 如果任务完成，那么只读 Channel 将会永远关闭
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#57c7ff>Err</span>() <span style=color:#9aedfe>error</span> <span style=color:#78787e>// 返回错误，如果还没有被 Done 完成，那么就是 nil，且会在取消函数CancelFunc执行完之后发生
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>    <span style=color:#57c7ff>Value</span>(key any) any <span style=color:#78787e>// 返回上下文携带的元数据
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>}
</span></span></code></pre></td></tr></table></div></div><p><code>Done()</code> 方法的返回值类型是个只读的，并且 Channel 中的数据类型是 <code>struct{}</code>，说明不返回任何数据，因此 <code>struct{}</code> 只是个内存占位。</p><p><code>Context</code> 由 <code>emptyCtx</code> 结构体实现：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> emptyCtx <span style=color:#9aedfe>int</span>
</span></span></code></pre></td></tr></table></div></div><p><code>emptyCtx</code> 除了 <code>Context</code> 接口中的方法，还实现了 <code>String()</code> 方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> (e <span style=color:#ff6ac1>*</span>emptyCtx) <span style=color:#57c7ff>String</span>() <span style=color:#9aedfe>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>switch</span> e {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>case</span> background:
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>return</span> <span style=color:#5af78e>&#34;context.Background&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>case</span> todo:
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>return</span> <span style=color:#5af78e>&#34;context.TODO&#34;</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> <span style=color:#5af78e>&#34;unknown empty Context&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>用来返回当前 Context 类型的字符串表示。</p><p>在 Go 语言中，变量首字母大写的为导出的函数或者变量，那么在 <code>context</code> 中，导出了如下的功能：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#78787e>// 几个错误
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>var</span> Canceled = errors.<span style=color:#57c7ff>New</span>(<span style=color:#5af78e>&#34;context canceled&#34;</span>) <span style=color:#78787e>// Context 取消时返回的错误
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>var</span> DeadlineExceeded <span style=color:#9aedfe>error</span> = deadlineExceededError{} <span style=color:#78787e>// Context 超过 deadline 时的错误
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>
</span></span><span style=display:flex><span><span style=color:#78787e>// 几个函数
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>type</span> CancelFunc <span style=color:#ff5c57>func</span>()
</span></span><span style=display:flex><span><span style=color:#ff5c57>type</span> CancelCauseFunc <span style=color:#ff5c57>func</span>(cause <span style=color:#9aedfe>error</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e>// 返回 Context 被取消的原因
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>Cause</span>(c Context) <span style=color:#9aedfe>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e>// 创建 Context 的方法
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>Background</span>() Context {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> background
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>TODO</span>() Context {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> todo
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e>// 一些 WithXxx 方法
</span></span></span><span style=display:flex><span><span style=color:#78787e></span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithCancel</span>(parent Context) (ctx Context, cancel CancelFunc) {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithCancelCause</span>(parent Context) (ctx Context, cancel CancelCauseFunc) {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithDeadline</span>(parent Context, d time.Time) (Context, CancelFunc) {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithTimeout</span>(parent Context, timeout time.Duration) (Context, CancelFunc) {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithValue</span>(parent Context, key, val any) Context {
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h1 id=几个错误>几个错误</h1><p><code>Canceled</code> 很简单，只是一个 errors 包创建的常量，没什么可说的。</p><p><code>DeadlineExceeded</code> 虽然也是一个 error 类型，但是是使用 <code>deadlineExceededError</code> 结构体创建的，其下面有3个方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> deadlineExceededError <span style=color:#ff5c57>struct</span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> (deadlineExceededError) <span style=color:#57c7ff>Error</span>() <span style=color:#9aedfe>string</span>   { <span style=color:#ff6ac1>return</span> <span style=color:#5af78e>&#34;context deadline exceeded&#34;</span> }
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> (deadlineExceededError) <span style=color:#57c7ff>Timeout</span>() <span style=color:#9aedfe>bool</span>   { <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>true</span> }
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> (deadlineExceededError) <span style=color:#57c7ff>Temporary</span>() <span style=color:#9aedfe>bool</span> { <span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>true</span> }
</span></span></code></pre></td></tr></table></div></div><h1 id=创建-context>创建 Context</h1><p><code>Background()</code> 和 <code>TODO()</code> 函数都是返回同样的 Context，但是 TODO 更适合任何场景，<code>Background()</code> 用于 Root Context 场景。本质上的实现逻辑是一样的：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>var</span> (
</span></span><span style=display:flex><span>	background = <span style=color:#ff5c57>new</span>(emptyCtx)
</span></span><span style=display:flex><span>	todo       = <span style=color:#ff5c57>new</span>(emptyCtx)
</span></span><span style=display:flex><span>)
</span></span></code></pre></td></tr></table></div></div><h1 id=增强-context>增强 Context</h1><h2 id=withcancel-方法>WithCancel 方法</h2><p><code>WithCancel()</code> 方法实现了 <code>canceler</code> 接口，其包含两个方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> canceler <span style=color:#ff5c57>interface</span> {
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>cancel</span>(removeFromParent <span style=color:#9aedfe>bool</span>, err, cause <span style=color:#9aedfe>error</span>)
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>Done</span>() <span style=color:#ff6ac1>&lt;-</span><span style=color:#ff5c57>chan</span> <span style=color:#ff5c57>struct</span>{}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>WithXxx 方法主要是增强 Context 的功能，例如 <code>WithCancel()</code> 方法用于为 Context 添加可取消能力。<code>WithCancel()</code> 方法本质是调用了 <code>withCancel()</code> 方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithCancel</span>(parent Context) (ctx Context, cancel CancelFunc) {
</span></span><span style=display:flex><span>	c <span style=color:#ff6ac1>:=</span> <span style=color:#57c7ff>withCancel</span>(parent)
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> c, <span style=color:#ff5c57>func</span>() { c.<span style=color:#57c7ff>cancel</span>(<span style=color:#ff6ac1>true</span>, Canceled, <span style=color:#ff6ac1>nil</span>) }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>而 <code>withCancel()</code> 方法的主要任务就是返回一个 <code>cancelCtx</code> 对象：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>withCancel</span>(parent Context) <span style=color:#ff6ac1>*</span>cancelCtx {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> parent <span style=color:#ff6ac1>==</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff5c57>panic</span>(<span style=color:#5af78e>&#34;cannot create context from nil parent&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	c <span style=color:#ff6ac1>:=</span> <span style=color:#57c7ff>newCancelCtx</span>(parent)
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>propagateCancel</span>(parent, c)
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> c
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>其中 <code>newCancelCtx()</code> 方法是创建返回值对象的工厂函数。</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> cancelCtx <span style=color:#ff5c57>struct</span> {
</span></span><span style=display:flex><span>	Context
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	mu       sync.Mutex            <span style=color:#78787e>// protects following fields
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	done     atomic.Value          <span style=color:#78787e>// of chan struct{}, created lazily, closed by first cancel call
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	children <span style=color:#ff5c57>map</span>[canceler]<span style=color:#ff5c57>struct</span>{} <span style=color:#78787e>// set to nil by the first cancel call
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	err      <span style=color:#9aedfe>error</span>                 <span style=color:#78787e>// set to non-nil by the first cancel call
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>	cause    <span style=color:#9aedfe>error</span>                 <span style=color:#78787e>// set to non-nil by the first cancel call
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>}
</span></span></code></pre></td></tr></table></div></div><p>在 <code>newCancelCtx()</code> 方法内部将原来的 Context 传递给 <code>cancelCtx</code> 内部的 <code>Context</code> 字段。由于 Context 在多个 Goroutine 中并发的被修改，因此通过 <code>mu</code> 这个互斥锁来保护数据。
<code>err</code> 和 <code>cause</code> 虽然都是错误类型，但是 <code>err</code> 支持存储了错误，<code>cause</code> 存储了错误原因。<code>children</code> 字段保存了当前 Context 节点下面的全部子 Context 节点。</p><p><code>propagateCancel</code> 将父 Context 节点和新的 Context 节点传入，是用来判断父节点是否一个被 Done，如果 Done，那么全部子节点也应该 Done，通过一个 Goroutine 实现的：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>propagateCancel</span>(parent Context, child canceler) {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>		goroutines.<span style=color:#57c7ff>Add</span>(<span style=color:#ff9f43>1</span>)
</span></span><span style=display:flex><span>		<span style=color:#ff6ac1>go</span> <span style=color:#ff5c57>func</span>() {
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>select</span> {
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>case</span> <span style=color:#ff6ac1>&lt;-</span>parent.<span style=color:#57c7ff>Done</span>():
</span></span><span style=display:flex><span>				child.<span style=color:#57c7ff>cancel</span>(<span style=color:#ff6ac1>false</span>, parent.<span style=color:#57c7ff>Err</span>(), <span style=color:#57c7ff>Cause</span>(parent))
</span></span><span style=display:flex><span>			<span style=color:#ff6ac1>case</span> <span style=color:#ff6ac1>&lt;-</span>child.<span style=color:#57c7ff>Done</span>():
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}()
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=withcancelcause>WithCancelCause</h2><p><code>WithCancelCause</code> 更加简单，本质上就是带有 Cause 的 <code>WithCancel()</code> 方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithCancelCause</span>(parent Context) (ctx Context, cancel CancelCauseFunc) {
</span></span><span style=display:flex><span>	c <span style=color:#ff6ac1>:=</span> <span style=color:#57c7ff>withCancel</span>(parent)
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> c, <span style=color:#ff5c57>func</span>(cause <span style=color:#9aedfe>error</span>) { c.<span style=color:#57c7ff>cancel</span>(<span style=color:#ff6ac1>true</span>, Canceled, cause) }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>其中参数 <code>CancelCauseFunc</code> 用于设置读取 Cause 的回调函数。</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> CancelCauseFunc <span style=color:#ff5c57>func</span>(cause <span style=color:#9aedfe>error</span>)
</span></span></code></pre></td></tr></table></div></div><h2 id=withdeadline>WithDeadline</h2><p><code>WithDeadline()</code> 方法是具有 Timer 定时功能的 <code>WithCancel()</code> 方法，其主要逻辑如下：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithDeadline</span>(parent Context, d time.Time) (Context, CancelFunc) {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	c <span style=color:#ff6ac1>:=</span> <span style=color:#ff6ac1>&amp;</span>timerCtx{
</span></span><span style=display:flex><span>		cancelCtx: <span style=color:#57c7ff>newCancelCtx</span>(parent),
</span></span><span style=display:flex><span>		deadline:  d,
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#57c7ff>propagateCancel</span>(parent, c)
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>if</span> c.err <span style=color:#ff6ac1>==</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		c.timer = time.<span style=color:#57c7ff>AfterFunc</span>(dur, <span style=color:#ff5c57>func</span>() {
</span></span><span style=display:flex><span>			c.<span style=color:#57c7ff>cancel</span>(<span style=color:#ff6ac1>true</span>, DeadlineExceeded, <span style=color:#ff6ac1>nil</span>)
</span></span><span style=display:flex><span>		})
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>...</span>
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> c, <span style=color:#ff5c57>func</span>() { c.<span style=color:#57c7ff>cancel</span>(<span style=color:#ff6ac1>true</span>, Canceled, <span style=color:#ff6ac1>nil</span>) }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>可以看到方法内部创建一个 <code>timerCtx</code> 结构体：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> timerCtx <span style=color:#ff5c57>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>*</span>cancelCtx
</span></span><span style=display:flex><span>	timer <span style=color:#ff6ac1>*</span>time.Timer <span style=color:#78787e>// Under cancelCtx.mu.
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>
</span></span><span style=display:flex><span>	deadline time.Time
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>timerCtx</code> 在 <code>cancelCtx</code> 的基础之上加入了 <code>time.Timer</code> 定时器和 <code>deadline</code> 作为超时时间。
并且，<code>timerCtx</code> 结构体还提供了更多的方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> (c <span style=color:#ff6ac1>*</span>timerCtx) <span style=color:#57c7ff>Deadline</span>() (deadline time.Time, ok <span style=color:#9aedfe>bool</span>) {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> c.deadline, <span style=color:#ff6ac1>true</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> (c <span style=color:#ff6ac1>*</span>timerCtx) <span style=color:#57c7ff>String</span>() <span style=color:#9aedfe>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> <span style=color:#57c7ff>contextName</span>(c.cancelCtx.Context) <span style=color:#ff6ac1>+</span> <span style=color:#5af78e>&#34;.WithDeadline(&#34;</span> <span style=color:#ff6ac1>+</span>
</span></span><span style=display:flex><span>		c.deadline.<span style=color:#57c7ff>String</span>() <span style=color:#ff6ac1>+</span> <span style=color:#5af78e>&#34; [&#34;</span> <span style=color:#ff6ac1>+</span>
</span></span><span style=display:flex><span>		time.<span style=color:#57c7ff>Until</span>(c.deadline).<span style=color:#57c7ff>String</span>() <span style=color:#ff6ac1>+</span> <span style=color:#5af78e>&#34;])&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff5c57>func</span> (c <span style=color:#ff6ac1>*</span>timerCtx) <span style=color:#57c7ff>cancel</span>(removeFromParent <span style=color:#9aedfe>bool</span>, err, cause <span style=color:#9aedfe>error</span>) {
</span></span><span style=display:flex><span>	c.cancelCtx.<span style=color:#57c7ff>cancel</span>(<span style=color:#ff6ac1>false</span>, err, cause)
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> removeFromParent {
</span></span><span style=display:flex><span>		<span style=color:#78787e>// Remove this timerCtx from its parent cancelCtx&#39;s children.
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>		<span style=color:#57c7ff>removeChild</span>(c.cancelCtx.Context, c)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	c.mu.<span style=color:#57c7ff>Lock</span>()
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> c.timer <span style=color:#ff6ac1>!=</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		c.timer.<span style=color:#57c7ff>Stop</span>()
</span></span><span style=display:flex><span>		c.timer = <span style=color:#ff6ac1>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	c.mu.<span style=color:#57c7ff>Unlock</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p><code>propagateCancel()</code> 方法与之前的功能一样，判断子 Context 是否应该 Done。
在 <code>WithDeadline()</code> 方法中与超时相关的核心是 <code>time.AfterFunc()</code> 方法，判断该 Context 是否超时，然后 Done。</p><h2 id=withtimeout>WithTimeout</h2><p><code>WithTimeout()</code> 方法本质上是一个 <code>WithDeadline()</code> 方法，但是通过 time 库提供的 <code>Add()</code> 方法添加了超时时间。</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithTimeout</span>(parent Context, timeout time.Duration) (Context, CancelFunc) {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> <span style=color:#57c7ff>WithDeadline</span>(parent, time.<span style=color:#57c7ff>Now</span>().<span style=color:#57c7ff>Add</span>(timeout))
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=withvalue>WithValue</h2><p>Context 可以在整个 Goroutine 的调用链路中传递数据，通常我们推荐在 Context 传递轻量级的数据，尽量减少数据发生拷贝的次数和大小，例如 <code>TraceID</code> 而不是 <code>RequestBody</code>。</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>func</span> <span style=color:#57c7ff>WithValue</span>(parent Context, key, val any) Context {
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> parent <span style=color:#ff6ac1>==</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff5c57>panic</span>(<span style=color:#5af78e>&#34;cannot create context from nil parent&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> key <span style=color:#ff6ac1>==</span> <span style=color:#ff6ac1>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#ff5c57>panic</span>(<span style=color:#5af78e>&#34;nil key&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>if</span> !reflectlite.<span style=color:#57c7ff>TypeOf</span>(key).<span style=color:#57c7ff>Comparable</span>() {
</span></span><span style=display:flex><span>		<span style=color:#ff5c57>panic</span>(<span style=color:#5af78e>&#34;key is not comparable&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#ff6ac1>return</span> <span style=color:#ff6ac1>&amp;</span>valueCtx{parent, key, val}
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>该方法创建了 <code>valueCtx</code> 结构体对象，其中的定义如下：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#ff5c57>type</span> valueCtx <span style=color:#ff5c57>struct</span> {
</span></span><span style=display:flex><span>	Context
</span></span><span style=display:flex><span>	key, val any
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>我们可以看到内部使用了 <code>any</code> 类型来描述 <code>key</code> 和 <code>val</code>，也就是我们传入的轻量级数据。</p><p>至此，我们探究了 context 库的具体原理和实现，短小精悍的库在 Go 项目中到处使用，非常像 Java 或者 C# 中的 <code>ThreadLocal</code>。</p></div></div><footer id=footer><div class=footer-inner><div><div style=font-weight:700;margin-bottom:15px>发布地址</div><div><a href=https://bluemiaomiao.gitee.io>中国境内镜像</a></div><div><a href=https://bluemiaomiao.github.io>中国境外镜像</a></div></div><div><div style=font-weight:700;margin-bottom:15px>友情链接</div><div><a href=https://debuginn.cn>DebugInn</a></div><div><a href=https://blog.csdn.net/qq_43442524>普通Gopher</a></div></div><div><div style=font-weight:700;margin-bottom:15px>开源软件</div><div><a href=https://bluemiaomiao.github.io/fastdfs-spring-boot-starter/>FastDFS SpringBoot Starter</a></div></div><div><div style=font-weight:700;margin-bottom:15px>其他</div><div><a href=https://values.wecomz.com>WecomZ 价值观</a></div></div></div><div class=icp><div style=min-height:13px;min-width:13px;background-image:url(/image/beian.png);background-repeat:no-repeat;background-size:contain;margin-right:5px></div><div><a href=https://beian.miit.gov.cn target=_blank>鲁ICP备2023019133号</a></div></div></footer></body><script src=../../js/halo.js type=text/javascript></script></html>