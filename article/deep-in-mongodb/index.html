<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Halo的主页 - 深入 MongoDB</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><link rel=stylesheet href=../../css/halo.css><link rel=stylesheet href=../../css/github-markdown.css><link rel=stylesheet href=../../css/github-markdown-light.css><link rel=stylesheet href=../../css/markdown-rewrite.css><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><style>body{display:flex;flex-direction:column;align-items:center}a{color:#5e5e5e;text-decoration:none}</style></head><body><div id=mob-warning>当前内容暂不适配移动端。<br>请使用桌面端查看。</div><div id=top style=width:0;height:0></div><div class=top-button><a href=#top style=text-decoration:none>Top</a></div><div id=toc>目<br>录</div><div id=header><div style=width:100%;display:flex;align-items:center;height:100%><div class=disable-select style=display:flex;justify-content:flex-end;font-size:14pt;font-weight:700;color:#555><div style=margin-right:35px></div><div><a style=color:#555;text-decoration:none href=../../>&lt;Halo的主页/></a></div></div><div style=flex:1;display:flex;justify-content:flex-end;font-size:14pt;font-weight:700;color:#555><div style=margin-right:45px><a href=https://www.wecomz.com style=color:#555;text-decoration:none>WecomZ</a></div><div style=margin-right:45px><a href=../../article style=color:#555;text-decoration:none>文章</a></div><div style=margin-right:45px><a href=../../video style=color:#555;text-decoration:none>视频</a></div><div style=margin-right:45px><a href=../../about style=color:#555;text-decoration:none>关于</a></div><div style=margin-left:35px></div></div></div></div><div id=article-content><div class=content-header><div>《深入 MongoDB》</div><div style=font-size:10pt;height:100%;display:flex;align-items:flex-end;padding-bottom:12pt;color:#5e5e5e;font-weight:lighter>在2021/01/03 00:58:49更新，大约共600字。</div></div><div class=content-desc><div style=font-size:50pt;font-weight:700;color:#eee;padding-right:15px>“</div><div style=line-height:50pt;color:#9b9b9b>[迁移]看完就能掌握 MongoDB。</div><div style=font-size:50pt;font-weight:700;color:#eee;padding-left:15px>”</div></div><div class="content-area markdown-body"><p><strong>我不喜欢 MySQL。</strong></p><p>MongoDB 的设计极为暴力，笔者发现 MongoDB 的查询线程并没有通过统计数据或者成本核算引擎进行处理，而是开启多个线程直接去加载数据进行运算，最快的线程返回，慢的全部取消执行。不过，这样却使得 MongoDB 的并发性能超越了 MongoDB 和 PostgreSQL。MongoDB 是一个 <a href=https://zh.wikipedia.org/wiki/NoSQL>NoSQL</a> 类型的 OLTP（面向联机事务处理负载） 数据库，并且从源代码上支持了分布式的相关特性。笔者在万人规模的 Top10 公司工作，虽然很熟悉 MySQL，但是工作以后基本没有用过 MySQL 集群，因为 MySQL 的常用功能在 MongoDB 上都得到了支持，甚至做的更好。</p><p>并且，笔者中途闯过业，一开始购买的项目代码是 SpringBoot + MySQL 的，由于是创业公司，所以需求经常发生变动，频繁的发布新版本（几乎是每周一次或者两次更新）。这导致 MySQL 的 Schema 经常被修改，而且由于后端代码的并发处理并不是很好，导致依赖于 MySQL 的并发性能。笔者当时有 10万 日均活跃用户，所以在 2.0 版本的发布中要求合作方使用 MongoDB 作为数据存储，并发性能进一步得到了提高，而且也不用担心频繁修改 Schema 导致数据冲突了。MongoDB 提供的 Grid 存储也为笔者的创业公司解决了文件存储的难题。</p><p>MongoDB 使用的 NoSQL 使用了反范式设计，目前并没有完整的理论支持。MongoDB 依赖于 JSON 和 JavaScript 语法，对开发者来说比较简单。2010年后，MongoDB 的分布式特性主要依赖于分片来实现，分片的设计和调优相对复杂一些，主要考虑数据均衡带来的性能影响。
MongoDB 具备以下特性：</p><ul><li>灵活和快速的应对业务变化<ul><li>多类型：同一个 Collection 可以包含不同类型的字段的 Document 对象。</li><li>在线 Schema 变更：线上修改数据模式，无需应用和数据库下线和版本变更。</li><li>数据治理：支持 JSON Schema 来规范数据模式，提供数据治理能力。</li></ul></li><li>简单和快速的开发方式<ul><li>数据库引擎只需要在一个存储区读写。</li><li>反范式、无关联的组织，极大的优化了查询速度。</li><li>SDK 提供的 API 自然。</li></ul></li><li>原生的高可用和横向扩展<ul><li>一开始部署默认就是3个节点的复制集，提供5个9的高可用。</li><li>轻松支持 PB 级别的数据。</li><li>无缝扩展，对业务应用全透明，集群的调整对业务 SLA 无影响。</li></ul></li></ul><h1 id=入门>入门</h1><p>笔者的公司采用了内部 SaaS 化运维系统来通过 Workflow 的方式来部署 MongoDB 数据库集群。初创或者小型公司可能会在公有云服务购买服务器然后部署 MongoDB 集群。接下来让我们部署一下吧。</p><p>目前来看，MongoDB 分为社区版和企业版，企业版在生产环境中是收费的，支持 SQL 功能，一般情况下使用社区版即可。官网可以下载到 <code>tgz</code> 格式的压缩包，但是不是很全面，我们通常使用的有 Mongos、MongoDB、 MongoDB Tools、Mongo Shell，下载好这些 deb/rpm 文件后直接进行安装。</p><p>如果你想快速开始，使用 MongoDB Atlas 的云服务也是可以的。笔者采用的是 Ubuntu 22.04 LTS，可以通过在线 APT 仓库进行安装：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get install gnupg
</span></span><span style=display:flex><span>curl -fsSL https://pgp.mongodb.com/server-6.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-6.0.gpg --dearmor
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse&#34;</span> | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install -y mongodb-org
</span></span></code></pre></td></tr></table></div></div><p>上面的方法安装的都是稳定的最新版本。一般情况下推荐使用最新版本的 MongoDB，如果需要固化版本那么可以使用如下方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org-database hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org-server hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-mongosh hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org-mongos hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org-tools hold&#34;</span> | sudo dpkg --set-selections
</span></span></code></pre></td></tr></table></div></div><p>参考链接：<a href=https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-ubuntu/>在 Ubuntu 上安装 MongoDB 社区版</a></p><p>安装完成后会有这些命令：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mongod        
</span></span><span style=display:flex><span>mongodump     
</span></span><span style=display:flex><span>mongoexport   
</span></span><span style=display:flex><span>mongofiles    
</span></span><span style=display:flex><span>mongoimport   
</span></span><span style=display:flex><span>mongorestore  
</span></span><span style=display:flex><span>mongos        
</span></span><span style=display:flex><span>mongosh       
</span></span><span style=display:flex><span>mongostat     
</span></span><span style=display:flex><span>mongotop
</span></span></code></pre></td></tr></table></div></div><p>后面我们会一一介绍。MongoDB 会创建一个配置文件（<code>/etc/mongod.conf</code>）和 Systemd 服务单元（<code>/usr/lib/systemd/system/mongod.service</code>）。</p><blockquote><p>从MongoDB 4.4开始，如果打开文件数的值低于 64000，则会生成启动错误。</p><p>执行 <code>ulimit -a</code> 查看文件数。</p></blockquote><p>生产环境中笔者推荐使用以下配置：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#39;* soft nofile 1000000&#39;</span> &gt;&gt; /etc/security/limits.conf
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#39;* hard nofile 1000000&#39;</span> &gt;&gt; /etc/security/limits.conf
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#39;fs.file-max=1000000&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#39;vm.max_map_count=1000000&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sysctl -p
</span></span></code></pre></td></tr></table></div></div><p>并修改 Systemd 的配置（<code>/etc/systemd/system.conf</code>）:</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#57c7ff>DefaultLimitNOFILE</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>1000000</span>
</span></span></code></pre></td></tr></table></div></div><p>重启。有些操作系统非常不愿意修改 ulimit 的值，即便是修改上面的文件以后也返回的是默认值。为此 MongoDB 提供的服务单元配置文件自带了推荐的最大文件打开数：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#ff6ac1>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Description</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>MongoDB Database Server</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Documentation</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>https://docs.mongodb.org/manual</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>After</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>network-online.target</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Wants</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>network-online.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>User</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>mongodb</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Group</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>mongodb</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>EnvironmentFile</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>-/etc/default/mongod</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Environment</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;MONGODB_CONFIG_OVERRIDE_NOFORK=1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>ExecStart</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>/usr/bin/mongod --config /etc/mongod.conf</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>RuntimeDirectory</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>mongodb</span>
</span></span><span style=display:flex><span><span style=color:#78787e># file size</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitFSIZE</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#78787e># cpu time</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitCPU</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#78787e># virtual memory size</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitAS</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#78787e># open files</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitNOFILE</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>64000</span>
</span></span><span style=display:flex><span><span style=color:#78787e># processes/threads</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitNPROC</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>64000</span>
</span></span><span style=display:flex><span><span style=color:#78787e># locked memory</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitMEMLOCK</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#78787e># total threads (user+kernel)</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>TasksMax</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>TasksAccounting</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Recommended limits for mongod as specified in</span>
</span></span><span style=display:flex><span><span style=color:#78787e># https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>WantedBy</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>multi-user.target</span>
</span></span></code></pre></td></tr></table></div></div><p>参考链接：</p><ul><li><a href=http://www.jinbuguo.com/systemd/systemd.unit.html#>金步国作品集</a></li><li><a href=https://ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html>阮一峰的网络日志</a></li></ul><p>通过 APT 源安装的 MongoDB 无需修改操作系统最大文件打开数限制。使用下面的命令启动 MongoDB 服务并设置为开机自启动：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl start mongod <span style=color:#ff6ac1>&amp;&amp;</span> systemctl <span style=color:#ff5c57>enable</span> mongod
</span></span></code></pre></td></tr></table></div></div><p>我们可以通过 MongoDB Shell 来连接到 MongoDB Server 执行测试操作，MongoDB Shell 内置了 JavaScript 引擎。</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mongosh --host localhost --port <span style=color:#ff9f43>27017</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>启动后会提示 WiredTiger 推荐使用 XFS 文件系统，实际生产经验中 XFS 的周边修复工具特别少，并且容易在重启的时候被破坏，不推荐使用。推荐使用 EXT4 或者 ZFS。</strong> 下面我们可以查看一下全部的数据库：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>test&gt; show dbs;
</span></span><span style=display:flex><span>admin   40.00 KiB
</span></span><span style=display:flex><span>config  12.00 KiB
</span></span><span style=display:flex><span><span style=color:#ff5c57>local</span>   72.00 KiB
</span></span></code></pre></td></tr></table></div></div><p>除了基本的增删改查操作，MongoDB 自带了聚合框架。可以作用在一个或者多个集合上，然后将这些数据转化为期望的形式。相当于 SQL 中的 GROUP BY 、JOIN 操作。整个聚合运算过程称为 Pipeline，它是由多个 Stage 构成的。每一个 Stage 接收数据并进行处理，然后返回给下一个 Stage 作为输入。</p><p><img src=../../article/deep-in-mongodb/pipeline-stage.svg alt></p><p>首先要定义一个 pipeline：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>pipeline <span style=color:#ff6ac1>=</span> [$stage1, $stage2, ..., $stageN];
</span></span><span style=display:flex><span>db.<span style=color:#ff6ac1>&lt;</span>CollectionName<span style=color:#ff6ac1>&gt;</span>.aggregate(pipeline, { options });
</span></span></code></pre></td></tr></table></div></div><p>Pipeline 一定是在一个 Collection 上操作的。Stage 中有如下操作：</p><ul><li><code>$match</code>：过滤，等价于 SQL 的 <code>where</code>。</li><li><code>$project</code>：投影，等价于 SQL 的 <code>as</code>。</li><li><code>$sort</code>：排序，等价于 SQL 的 <code>order by</code>。</li><li><code>$group</code>：分组，等价于 SQL 的 <code>group by</code>。</li><li><code>$skip/$limit</code>：结果限制，等价于 SQL 的 <code>skip/limit</code>。</li><li><code>$lookup</code>：左外连接，等价于 SQL 的 <code>left outer join</code>。</li></ul><p>这个 Stage 中还有很多的运算符号，比如 <code>$project</code> 中有 <code>$map</code>、<code>$reduce</code>、<code>$filter</code> 等。</p><p><strong>复杂的聚合操作应该尽量将 <code>$match</code> 放到 <code>$project</code> 之前，否则可能导致无法利用索引加速。</strong></p><h1 id=模型与事务>模型与事务</h1><h1 id=集群运维>集群运维</h1><h2 id=复制集>复制集</h2><p>复制集主要意义在于服务高可用。它的实现依赖于两个方面的功能：</p><ul><li>数据写入时，数据迅速复制到另一个独立的节点。</li><li>在接受数据写入的节点发生故障时，MongoDB 将会自动选举出另一个新的节点进行写入。</li></ul><p>MongoDB 还实现了其他的几个附加作用：</p><ul><li>数据分发：将数据从一个区域复制到另一个区域，减少另一个区域的读延迟。</li><li>读写分离：不同类型的压力分别在不同的节点上运行。</li><li>异地容灾：在数据中心故障的时候快速切换到异地。</li></ul><p>一个典型的复制集由3个以上具有投票权的节点组成，包括：</p><ul><li>主节点：接受写入和选举时投票。</li><li>从节点：复制主节点上的新数据和选举时投票。</li></ul><p><strong>数据是如何在节点间进行复制的呢？</strong> 与 Redis 主从架构一致，当一个写操作到达主节点，它对数据的操作将会被记录下来，这些记录成为 Oplog。从节点通过在主节点打开一个 tailable 游标不断的获取主节点的 Oplog，并在自己的数据上进行回放，以此与主节点保持一致。如果从节点的同步过于滞后或者新加入复制集，那么从节点将会进行重同步，清空本地数据库。至于滞后多少，取决于 Oplog 窗口值的大小。太多的从节点向主节点发送同步请求，导致主节点的访问压力变大，每增加一个从节点会导致主节点存在 10% 的性能影响。主从架构的的读写分离对于可以用于报表业务、历史数据或者日志等场景。如果想提高主节点性能，可以使用 InMemory（企业版） 存储引擎而不是 WT。</p><p><strong>节点间选举是如何完成的？</strong> 具有投票权的节点两两之间互相发送心跳。当没有超过5次心跳时判断节点失联。如果失联的是主节点，那么就要开始选举了。选举基于 RAFT 算法，成功的必要条件是大多数投票节点存活。复制集中最多有50个节点，但是具有投票权的只有7个。</p><p>值得注意的是，复制集并没有对数据做分布式存储，只是简单的热备份。Oplog本质上也是一个 <code>Collection</code> 存储在 <code>local</code> 数据库中。</p><p><strong>影响选举的因素有哪些呢？</strong> 首先整个集群必须有大多数节点存活，被选举的主节点必须能够与多数节点建立连接，具有较新的 Oplog，具有较高的优先级（如果通过配置文件配置）。</p><p>复制集节点有常见以下几个配置：</p><ul><li><code>v</code> 参数用于决定是否具有投票权。</li><li><code>priority</code> 参数用来配置选举优先级。当值为0的时候无法成为主节点。</li><li><code>hidden</code> 参数用来配置复制数据，但是对于应用不可见，隐藏的节点具备投票权但是优先级必须为0。</li><li><code>slaveDelay</code> 参数用于复制n秒之前的数据，保持与主节点的时间差，可以用于防止数据误删除。</li></ul><p>对于复制集来说，推荐所有的节点配置都一样，因为任何节点都有可能成为主节点，并且硬件上必须具有独立性。MongoDB 部署复制集的时候软件版本必须一致。对于复制集来说，由于只有主节点承担写请求，那么增加节点不会增加系统的写性能。</p><h1 id=场景>场景</h1></div></div><footer id=footer><div class=footer-inner><div><div style=font-weight:700;margin-bottom:15px>发布地址</div><div><a href=https://halo.wecomz.com>Halo的主页</a></div><div><a href=https://bluemiaomiao.gitee.io>中国境内镜像</a></div><div><a href=https://bluemiaomiao.github.io>中国境外镜像</a></div></div><div><div style=font-weight:700;margin-bottom:15px>友情链接</div><div><a href=https://debuginn.cn>DebugInn</a></div><div><a href=https://blog.csdn.net/qq_43442524>普通Gopher</a></div></div><div><div style=font-weight:700;margin-bottom:15px>开源软件</div><div><a href=https://bluemiaomiao.github.io/libsshd/>OpenSSH Configuration Library</a></div><div><a href=https://bluemiaomiao.github.io/fastdfs-spring-boot-starter/>FastDFS SpringBoot Starter</a></div><div><a href=https://bluemiaomiao.github.io/librocm-smi-gobinding/>AMD ROCm SMI for Golang</a></div><div><a href=https://bluemiaomiao.github.io/libnvml-smi-gobinding>NVIDIA NVML SMI for Golang</a></div><div><a href=https://www.wecomz.com/software/zgraphics>zGraphics(Prometheus GPU Exporter)</a></div><div><a href=https://www.wecomz.com/software/ztrader>zTrader Framework</a></div></div><div><div style=font-weight:700;margin-bottom:15px>其他</div><div><a href=https://values.wecomz.com>WecomZ 价值观</a></div></div></div><div class=icp><div style=min-height:13px;min-width:13px;background-image:url(/image/beian.png);background-repeat:no-repeat;background-size:contain;margin-right:5px></div><div><a href=https://beian.miit.gov.cn target=_blank>鲁ICP备2023019133号</a></div></div></footer></body><script src=../../js/halo.js type=text/javascript></script></html>