<!doctype html><html lang=zh><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><title>Halo的主页 - 深入 MongoDB</title><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css><link rel=stylesheet href=../../css/halo.css><link rel=stylesheet href=../../css/github-markdown.css><link rel=stylesheet href=../../css/github-markdown-light.css><link rel=stylesheet href=../../css/markdown-rewrite.css><link rel="shortcut icon" href=favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=../../apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=../../favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=../../favicon-16x16.png><link rel=manifest href=../../site.webmanifest><link rel=mask-icon href=../../safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#ffffff"><meta name=theme-color content="#ffffff"><style>body{display:flex;flex-direction:column;align-items:center}a{color:#5e5e5e;text-decoration:none}</style></head><body><div id=mob-warning>当前内容暂不适配移动端。<br>请使用桌面端查看。</div><div id=top style=width:0;height:0></div><div class=top-button><a href=#top style=text-decoration:none>Top</a></div><div id=toc>目<br>录</div><div id=header><div style=width:100%;display:flex;align-items:center;height:100%><div class=disable-select style=display:flex;justify-content:flex-end;font-size:14pt;font-weight:700;color:#555><div style=margin-right:35px></div><div><a style=color:#555;text-decoration:none href=../../>&lt;Halo的主页/></a></div></div><div style=flex:1;display:flex;justify-content:flex-end;font-size:14pt;font-weight:700;color:#555><div style=margin-right:45px><a href=https://www.wecomz.com style=color:#555;text-decoration:none>WecomZ</a></div><div style=margin-right:45px><a href=../../article style=color:#555;text-decoration:none>文章</a></div><div style=margin-right:45px><a href=../../video style=color:#555;text-decoration:none>视频</a></div><div style=margin-right:45px><a href=../../about style=color:#555;text-decoration:none>关于</a></div><div style=margin-left:35px></div></div></div></div><div id=article-content><div class=content-header><div>《深入 MongoDB》</div><div style=font-size:10pt;height:100%;display:flex;align-items:flex-end;padding-bottom:12pt;color:#5e5e5e;font-weight:lighter>在2021/01/03 00:58:49更新，大约共1100字。</div></div><div class=content-desc><div style=font-size:50pt;font-weight:700;color:#eee;padding-right:15px>“</div><div style=line-height:50pt;color:#9b9b9b>[迁移]看完就能掌握 MongoDB。</div><div style=font-size:50pt;font-weight:700;color:#eee;padding-left:15px>”</div></div><div class="content-area markdown-body"><p><strong>我不喜欢 MySQL。</strong></p><p>MongoDB 的设计极为暴力，笔者发现 MongoDB 的查询线程并没有通过统计数据或者成本核算引擎进行处理，而是开启多个线程直接去加载数据进行运算，最快的线程返回，慢的全部取消执行。不过，这样却使得 MongoDB 的并发性能超越了 MongoDB 和 PostgreSQL。MongoDB 是一个 <a href=https://zh.wikipedia.org/wiki/NoSQL>NoSQL</a> 类型的 OLTP（面向联机事务处理负载） 数据库，并且从源代码上支持了分布式的相关特性。笔者在万人规模的 Top10 公司工作，虽然很熟悉 MySQL，但是工作以后基本没有用过 MySQL 集群，因为 MySQL 的常用功能在 MongoDB 上都得到了支持，甚至做的更好。</p><p>并且，笔者中途闯过业，一开始购买的项目代码是 SpringBoot + MySQL 的，由于是创业公司，所以需求经常发生变动，频繁的发布新版本（几乎是每周一次或者两次更新）。这导致 MySQL 的 Schema 经常被修改，而且由于后端代码的并发处理并不是很好，导致依赖于 MySQL 的并发性能。笔者当时有 10万 日均活跃用户，所以在 2.0 版本的发布中要求合作方使用 MongoDB 作为数据存储，并发性能进一步得到了提高，而且也不用担心频繁修改 Schema 导致数据冲突了。MongoDB 提供的 Grid 存储也为笔者的创业公司解决了文件存储的难题。</p><p>MongoDB 使用的 NoSQL 使用了反范式设计，目前并没有完整的理论支持。MongoDB 依赖于 JSON 和 JavaScript 语法，对开发者来说比较简单。2010年后，MongoDB 的分布式特性主要依赖于分片来实现，分片的设计和调优相对复杂一些，主要考虑数据均衡带来的性能影响。
MongoDB 具备以下特性：</p><ul><li>灵活和快速的应对业务变化<ul><li>多类型：同一个 Collection 可以包含不同类型的字段的 Document 对象。</li><li>在线 Schema 变更：线上修改数据模式，无需应用和数据库下线和版本变更。</li><li>数据治理：支持 JSON Schema 来规范数据模式，提供数据治理能力。</li><li>大型文档支持：每个 Document 最大支持 16MB。</li></ul></li><li>简单和快速的开发方式<ul><li>数据库引擎只需要在一个存储区读写。</li><li>反范式、无关联的组织，极大的优化了查询速度。</li><li>SDK 提供的 API 自然。</li></ul></li><li>原生的高可用和横向扩展<ul><li>一开始部署默认就是3个节点的复制集，提供5个9的高可用。</li><li>轻松支持 PB 级别的数据。</li><li>无缝扩展，对业务应用全透明，集群的调整对业务 SLA 无影响。</li></ul></li></ul><h1 id=入门>入门</h1><p>笔者的公司采用了内部 SaaS 化运维系统来通过 Workflow 的方式来部署 MongoDB 数据库集群。初创或者小型公司可能会在公有云服务购买服务器然后部署 MongoDB 集群。接下来让我们部署一下吧。</p><p>目前来看，MongoDB 分为社区版和企业版，企业版在生产环境中是收费的，支持 SQL 功能，一般情况下使用社区版即可。官网可以下载到 <code>tgz</code> 格式的压缩包，但是不是很全面，我们通常使用的有 Mongos、MongoDB、 MongoDB Tools、Mongo Shell，下载好这些 deb/rpm 文件后直接进行安装。</p><h2 id=安装>安装</h2><p>如果你想快速开始，使用 MongoDB Atlas 的云服务也是可以的。笔者采用的是 Ubuntu 22.04 LTS，可以通过在线 APT 仓库进行安装：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sudo apt-get install gnupg
</span></span><span style=display:flex><span>curl -fsSL https://pgp.mongodb.com/server-6.0.asc | sudo gpg -o /usr/share/keyrings/mongodb-server-6.0.gpg --dearmor
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;deb [ arch=amd64,arm64 signed-by=/usr/share/keyrings/mongodb-server-6.0.gpg ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse&#34;</span> | sudo tee /etc/apt/sources.list.d/mongodb-org-6.0.list
</span></span><span style=display:flex><span>sudo apt-get update
</span></span><span style=display:flex><span>sudo apt-get install -y mongodb-org
</span></span></code></pre></td></tr></table></div></div><p>上面的方法安装的都是稳定的最新版本。一般情况下推荐使用最新版本的 MongoDB，如果需要固化版本那么可以使用如下方法：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org-database hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org-server hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-mongosh hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org-mongos hold&#34;</span> | sudo dpkg --set-selections
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#34;mongodb-org-tools hold&#34;</span> | sudo dpkg --set-selections
</span></span></code></pre></td></tr></table></div></div><p>参考链接：<a href=https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-ubuntu/>在 Ubuntu 上安装 MongoDB 社区版</a></p><p>安装完成后会有这些命令：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mongod        
</span></span><span style=display:flex><span>mongodump     
</span></span><span style=display:flex><span>mongoexport   
</span></span><span style=display:flex><span>mongofiles    
</span></span><span style=display:flex><span>mongoimport   
</span></span><span style=display:flex><span>mongorestore  
</span></span><span style=display:flex><span>mongos        
</span></span><span style=display:flex><span>mongosh       
</span></span><span style=display:flex><span>mongostat     
</span></span><span style=display:flex><span>mongotop
</span></span></code></pre></td></tr></table></div></div><p>后面我们会一一介绍。MongoDB 会创建一个配置文件（<code>/etc/mongod.conf</code>）和 Systemd 服务单元（<code>/usr/lib/systemd/system/mongod.service</code>）。</p><blockquote><p>从MongoDB 4.4开始，如果打开文件数的值低于 64000，则会生成启动错误。</p><p>执行 <code>ulimit -a</code> 查看文件数。</p></blockquote><p>生产环境中笔者推荐使用以下配置：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#39;* soft nofile 1000000&#39;</span> &gt;&gt; /etc/security/limits.conf
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#39;* hard nofile 1000000&#39;</span> &gt;&gt; /etc/security/limits.conf
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#39;fs.file-max=1000000&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></span><span style=display:flex><span><span style=color:#ff5c57>echo</span> <span style=color:#5af78e>&#39;vm.max_map_count=1000000&#39;</span> &gt;&gt; /etc/sysctl.conf
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>sysctl -p
</span></span></code></pre></td></tr></table></div></div><p>并修改 Systemd 的配置（<code>/etc/systemd/system.conf</code>）:</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#57c7ff>DefaultLimitNOFILE</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>1000000</span>
</span></span></code></pre></td></tr></table></div></div><p>重启。有些操作系统非常不愿意修改 ulimit 的值，即便是修改上面的文件以后也返回的是默认值。为此 MongoDB 提供的服务单元配置文件自带了推荐的最大文件打开数：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#ff6ac1>[Unit]</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Description</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>MongoDB Database Server</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Documentation</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>https://docs.mongodb.org/manual</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>After</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>network-online.target</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Wants</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>network-online.target</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>[Service]</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>User</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>mongodb</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Group</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>mongodb</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>EnvironmentFile</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>-/etc/default/mongod</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>Environment</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>&#34;MONGODB_CONFIG_OVERRIDE_NOFORK=1&#34;</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>ExecStart</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>/usr/bin/mongod --config /etc/mongod.conf</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>RuntimeDirectory</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>mongodb</span>
</span></span><span style=display:flex><span><span style=color:#78787e># file size</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitFSIZE</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#78787e># cpu time</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitCPU</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#78787e># virtual memory size</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitAS</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#78787e># open files</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitNOFILE</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>64000</span>
</span></span><span style=display:flex><span><span style=color:#78787e># processes/threads</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitNPROC</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>64000</span>
</span></span><span style=display:flex><span><span style=color:#78787e># locked memory</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>LimitMEMLOCK</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#78787e># total threads (user+kernel)</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>TasksMax</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>infinity</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>TasksAccounting</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#78787e># Recommended limits for mongod as specified in</span>
</span></span><span style=display:flex><span><span style=color:#78787e># https://docs.mongodb.com/manual/reference/ulimit/#recommended-ulimit-settings</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff6ac1>[Install]</span>
</span></span><span style=display:flex><span><span style=color:#57c7ff>WantedBy</span><span style=color:#ff6ac1>=</span><span style=color:#5af78e>multi-user.target</span>
</span></span></code></pre></td></tr></table></div></div><p>参考链接：</p><ul><li><a href=http://www.jinbuguo.com/systemd/systemd.unit.html#>金步国作品集</a></li><li><a href=https://ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html>阮一峰的网络日志</a></li></ul><p>通过 APT 源安装的 MongoDB 无需修改操作系统最大文件打开数限制。使用下面的命令启动 MongoDB 服务并设置为开机自启动：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>systemctl start mongod <span style=color:#ff6ac1>&amp;&amp;</span> systemctl <span style=color:#ff5c57>enable</span> mongod
</span></span></code></pre></td></tr></table></div></div><p>我们可以通过 MongoDB Shell 来连接到 MongoDB Server 执行测试操作，MongoDB Shell 内置了 JavaScript 引擎。</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>mongosh --host localhost --port <span style=color:#ff9f43>27017</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>启动后会提示 WiredTiger 推荐使用 XFS 文件系统，实际生产经验中 XFS 的周边修复工具特别少，并且容易在重启的时候被破坏，不推荐使用。推荐使用 EXT4 或者 ZFS。</strong> 下面我们可以查看一下全部的数据库：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>test&gt; show dbs;
</span></span><span style=display:flex><span>admin   40.00 KiB
</span></span><span style=display:flex><span>config  12.00 KiB
</span></span><span style=display:flex><span><span style=color:#ff5c57>local</span>   72.00 KiB
</span></span></code></pre></td></tr></table></div></div><h2 id=聚合框架>聚合框架</h2><p>除了基本的增删改查操作，MongoDB 自带了聚合框架。可以作用在一个或者多个集合上，然后将这些数据转化为期望的形式。相当于 SQL 中的 GROUP BY 、JOIN 操作。整个聚合运算过程称为 Pipeline，它是由多个 Stage 构成的。每一个 Stage 接收数据并进行处理，然后返回给下一个 Stage 作为输入。</p><p><img src=../../article/deep-in-mongodb/pipeline-stage.svg alt></p><p>首先要定义一个 pipeline：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>pipeline <span style=color:#ff6ac1>=</span> [$stage1, $stage2, ..., $stageN];
</span></span><span style=display:flex><span>db.<span style=color:#ff6ac1>&lt;</span>CollectionName<span style=color:#ff6ac1>&gt;</span>.aggregate(pipeline, { options });
</span></span></code></pre></td></tr></table></div></div><p>Pipeline 一定是在一个 Collection 上操作的。Stage 中有如下操作：</p><ul><li><code>$match</code>：过滤，等价于 SQL 的 <code>where</code>。</li><li><code>$project</code>：投影，等价于 SQL 的 <code>as</code>。</li><li><code>$sort</code>：排序，等价于 SQL 的 <code>order by</code>。</li><li><code>$group</code>：分组，等价于 SQL 的 <code>group by</code>。</li><li><code>$skip/$limit</code>：结果限制，等价于 SQL 的 <code>skip/limit</code>。</li><li><code>$lookup</code>：左外连接，等价于 SQL 的 <code>left outer join</code>，不支持分片表。</li></ul><p>这个 Stage 中还有很多的运算符号，比如 <code>$project</code> 中有 <code>$map</code>、<code>$reduce</code>、<code>$filter</code> 等。</p><p><strong>复杂的聚合操作应该尽量将 <code>$match</code> 放到 <code>$project</code> 之前，否则可能导致无法利用索引加速。</strong></p><h2 id=mongodb-charts>MongoDB Charts</h2><p>通过拖拽的图形化交互构建可视化图表，可以直接读取 MongoDB 中的数据。</p><p>通过 iframe 的方式嵌入到其他的应用程序中。</p><h1 id=模型与事务>模型与事务</h1><h2 id=模型设计>模型设计</h2><p>MongoDB 不遵从第三范式，并且允许冗余的数据存在。在进行业务建模的时候，首先分析好 Document 中应该存储哪些要素，然后按照性能进行优化：</p><ul><li>最频繁的数据查询模式</li><li>最常用的查询参数</li><li>最频繁的数据写入模式</li><li>读写操作的比例</li><li>数据量的大小</li></ul><p>对于时序数据，可以采用分桶的设计思路，例如将分钟级别的数据进行合并，每小时一个 Document 而不是每分钟一个 Document。这样可以大大减少存储的体积，并且可以减少索引数量，提高查询效率。</p><h2 id=写操作事务>写操作事务</h2><p>影响写操作行为的参数是 <code>writeConcern</code>，决定了一个写操作达到多少节点才算成功。<code>w</code> 参数取值包括：</p><ul><li><code>0</code>：发起写操作，不关心是否成功。</li><li><code>1</code> 到集群中最大的节点数：集群中写操作被复制到多少个节点才算成功。这个值如果不是集群中的大多数，可能会导致写操作丢数据。</li><li><code>majority</code>：写操作被复制到大多数节点上才算成功。</li><li><code>all</code>：写操作被全部节点接受以后才算成功，如果集群中的节点宕机，可能导致写操作一直完不成。</li></ul><p>而 <code>journal</code> 定义如何才算成功，<code>j</code> 参数的取值包括：</p><ul><li><code>true</code>：写操作落到日志文件才算成功。</li><li><code>false</code>：写操作到达内存就算成功。</li></ul><p>发起写操作的程序将被阻塞到写操作到达指定的节点数为止。</p><p>以上参数通过 SDK 提供的 API 或者 MongoDB Shell 都可以进行设置，因为这些参数属于客户端参数。测试：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#78787e>// 在复制集测试参数
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>db.test.insert({count<span style=color:#ff6ac1>:</span> <span style=color:#ff9f43>1</span>}, {writeConcern<span style=color:#ff6ac1>:</span> <span style=color:#5af78e>&#34;majority&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#78787e>// 模拟网络延时
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>conf <span style=color:#ff6ac1>=</span> rs.conf()
</span></span><span style=display:flex><span>conf.members[<span style=color:#ff9f43>2</span>].slaveDelay <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>5</span> <span style=color:#78787e>// 5秒
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>conf.members[<span style=color:#ff9f43>2</span>].priority <span style=color:#ff6ac1>=</span> <span style=color:#ff9f43>0</span> <span style=color:#78787e>// 选举优先级
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>rs.reconfig(conf)
</span></span><span style=display:flex><span><span style=color:#78787e>// 观察复制延迟下的写入
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>db.test.insert({count<span style=color:#ff6ac1>:</span> <span style=color:#ff9f43>2</span>}, {writeConcern<span style=color:#ff6ac1>:</span> <span style=color:#5af78e>&#34;majority&#34;</span>})
</span></span></code></pre></td></tr></table></div></div><p>当给写操作配置了 <code>wtimeout</code> 参数时，可能会由于网络波动导致写入出错（等待副本写入超时），但是数据还是写进去了。这就要根据业务进行一些处理了。</p><h2 id=读操作事务>读操作事务</h2><p>针对读操作的事务处理，需要关注两个问题：</p><ul><li>从哪个节点读取，由 <code>readPreference</code> 控制。</li><li>数据隔离性，由 <code>readConcern</code> 控制。</li></ul><p>对于 <code>readPerference</code> 有以下几个可选值：</p><ul><li><code>primary</code>：只选择主节点。默认值。</li><li><code>primaryPreferred</code>：优选选择主节点，如果不可用才选择从节点。</li><li><code>secondary</code>：只选择从节点。</li><li><code>secondaryPreferred</code>：优先选择从节点，如果从节点不可用则选择主节点。</li><li><code>nearest</code>：选择最近的节点。</li></ul><p>另外，MongoDB 还支持从指定的 Tag 读取数据，需要给 MongoDB 关联 Tag，然后在客户端指定 Tag。</p><p>有三个地方可以指定读取的数据库节点：</p><ul><li>MongoDB 连接字符串的 <code>readPreference</code> 参数。</li><li>MongoDB 驱动程序 API。</li><li>MongoDB Shell 的 <code>readPref()</code> 函数。</li></ul><p>测试：</p><p>主节点写入数据后，各个从节点已经将数据同步完成。在从节点执行 <code>db.fsyncLock()</code> 将同步 Oplog 操作锁定。然后再去从节点写入。</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>db.test.find()
</span></span><span style=display:flex><span>db.test.find().readPref(<span style=color:#5af78e>&#34;secondary&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>然后使用 <code>db.fsyncUnlock()</code> 解锁，再去读取。</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>db.test.find().redPref(<span style=color:#5af78e>&#34;secondary&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>读取操作应该考虑高可用，如果将 <code>readPreference</code> 设置为 <code>primary</code>，但是主节点宕机后会导致故障转移期间没有节点可用。如果业务允许，则应该将参数值设置为 <code>primaryPreferred</code>。</p><p>在使用 Tag 的情况，如果与 Tag 关联的节点全部失效也会导致没有节点可用。</p><p>对于 <code>readConcern</code> 有以下几个可选值：</p><ul><li><code>available</code>：读取所有可用的数据。从节点默认值。</li><li><code>local</code>：读取所有可用且属于当前分片的数据。主节点默认值。MongoDB &lt;=3.6.x 的版本不支持对从节点使用 <code>local</code>。</li><li><code>majority</code>：读取在大多数节点上提交完成的数据。安全的，防止脏读，对应关系型数据库的读已提交级别。要使用该参数，需要在 MongoDB Server 的配置文件中写入：<div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>replication</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>enableMajorityReadConcern</span>: <span style=color:#ff6ac1>true</span>
</span></span></code></pre></td></tr></table></div></div></li><li><code>linearizable</code>：可线性化读取文档。读取速度比较慢，因此建议配合 <code>maxTimeMS</code> 使用。</li><li><code>snapshot</code>：读取最近快照中的数据。只在多文档事务中生效，最高级别的读取。不会出现脏读、不可重复读和幻读。</li></ul><p><code>available</code> 与 <code>local</code> 在复制集上没什么区别，在分片集群中才会有区别。MongoDB 在执行数据均衡操作的时候会发生 Chunk 的迁移。如果我们要在新分片中读取数据，那么：</p><ul><li><code>available</code>：config 中的记录的仍然是旧分片，但是能够读取到迁移中的数据，即便数据在新分片中没有迁移完。</li><li><code>local</code>：不会读取到迁移中的数据。只有当 config 中记录的 Chunk 已经属于新分片。</li></ul><p>对于测试，依旧可以使用插入操作和锁住 Oplog 同步来模拟。</p><h2 id=多文档事务>多文档事务</h2><p>大部分场景不推荐使用事务，应该通过合理的设计文档模型来避免使用事务。MongoDB 也有类似于 ACID 的保证。对于原子性，MongoDB 单 Document 在 1.x 版本就支持了，复制集多 Document 在 4.0 支持，分片集群的原子性在 4.2 支持。一致性使用 <code>readConcern</code> 和 <code>writeConcern</code> 保证。隔离性使用 <code>readConcern</code> 保证。持久性使用副本和日志保证。</p><p>事务默认会在60秒内完成，否则会被取消。事务的执行影响 Chunk 迁移的效率，而且正在迁移的 Chunk 会导致事务取消，因此需要重试。多文档事务必须使用主节点进行操作。涉及事务的分片不能使用仲裁节点。</p><p>对于事务的冲突错误，MongoDB 并不是与 MySQL 一致的：</p><ul><li>当一个事务开始，如果事务要修改的文档被其他事务修改过，那么当前事务会发生错误。</li><li>如果一个事务已经开始修改一个文档，其他事务在尝试修改，那么其他事务会等待。</li></ul><p>对于事务，应该尽量控制在 1000个文档以内的更新。</p><h2 id=change-stream>Change Stream</h2><p>类似于 SQL 数据库的触发器，但是 MongoDB 的 Change Stream 是异步回调事件。并且触发次数也不是1次，而是每个订阅事件的客户端，当发生故障恢复的时候，从上次断点重新触发。</p><p>Change Stream 基于 Oplog 实现的，在 Oplog 上开启一个 tailable 游标来追踪全部的节点上的变更操作，最终调用应用中定义的回调函数。</p><p>Change Stream 只会推送已经在大多数节点上提交的操作。对于某些类型的变更事件感兴趣可以使用聚合框架来实现：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#ff5c57>var</span> change <span style=color:#ff6ac1>=</span> db.collection.watch([{
</span></span><span style=display:flex><span>    $match<span style=color:#ff6ac1>:</span> {
</span></span><span style=display:flex><span>        operationType<span style=color:#ff6ac1>:</span> {
</span></span><span style=display:flex><span>            $in<span style=color:#ff6ac1>:</span> [<span style=color:#5af78e>&#39;insert&#39;</span>, <span style=color:#5af78e>&#39;delete&#39;</span>]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}])
</span></span></code></pre></td></tr></table></div></div><p>开启 Change Stream 功能需要以下配置：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>replication</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>enableMajorityReadConcern</span>: <span style=color:#ff6ac1>true</span>
</span></span></code></pre></td></tr></table></div></div><p>当故障恢复，想要从中断的地方继续获取 Change Stream，只需要保留上一次变更通知的 ID 即可。然后使用 <code>watch([], {resumeAfter: &lt;_id>})</code> 实现。</p><p>Change Stream 可以用于如下场景：</p><ul><li>跨集群复制：订阅源集群中的 Change Stream，然后一旦变更，那么就立即同步到当前集群。</li><li>微服务联动：当一个微服务变更数据库时，其他微服务得到通知并做出相应的变化。</li></ul><p>由于 Change Stream 依赖于 Oplog，因此中断时间不能超过 Oplog 回收的最大时间窗口。如果在 <code>$update</code> 操作时只更新了部分数据，那么由于后续的更新，Change Stream 的通知也是增量的。</p><h1 id=集群运维>集群运维</h1><p>MongoDB 有3中部署架构，常见的是单机版，然后是复制集和分片集。</p><p><img src=../../article/deep-in-mongodb/mongo-three-arch.svg alt></p><h2 id=连接>连接</h2><p>连接到 MongoDB 有两种协议：</p><ul><li><code>mongodb://节点1,节点2...,节点N/数据库名称?[参数]</code>：连接到复制集。</li><li><code>mongodb://mongos1,mongos2,...,mongosN/数据库名称?[参数]</code>：连接到分片集。</li><li><code>mongodb+srv://</code> 支持通过DNS 的 SRV 服务解析得到全部的mongos地址。</li></ul><h2 id=复制集>复制集</h2><p>复制集主要意义在于服务高可用。它的实现依赖于两个方面的功能：</p><ul><li>数据写入时，数据迅速复制到另一个独立的节点。</li><li>在接受数据写入的节点发生故障时，MongoDB 将会自动选举出另一个新的节点进行写入。</li></ul><p>MongoDB 还实现了其他的几个附加作用：</p><ul><li>数据分发：将数据从一个区域复制到另一个区域，减少另一个区域的读延迟。</li><li>读写分离：不同类型的压力分别在不同的节点上运行。</li><li>异地容灾：在数据中心故障的时候快速切换到异地。</li></ul><p>一个典型的复制集由3个以上具有投票权的节点组成，包括：</p><ul><li>主节点：接受写入和选举时投票。</li><li>从节点：复制主节点上的新数据和选举时投票。</li></ul><p><img src=../../article/deep-in-mongodb/replicaset.svg alt></p><p><strong>数据是如何在节点间进行复制的呢？</strong> 与 Redis 主从架构一致，当一个写操作到达主节点，它对数据的操作将会被记录下来，这些记录成为 Oplog。从节点通过在主节点打开一个 tailable 游标不断的获取主节点的 Oplog，并在自己的数据上进行回放，以此与主节点保持一致。如果从节点的同步过于滞后或者新加入复制集，那么从节点将会进行重同步，清空本地数据库。至于滞后多少，取决于 Oplog 窗口值的大小。太多的从节点向主节点发送同步请求，导致主节点的访问压力变大，每增加一个从节点会导致主节点存在 10% 的性能影响。主从架构的的读写分离对于可以用于报表业务、历史数据或者日志等场景。如果想提高主节点性能，可以使用 InMemory（企业版） 存储引擎而不是 WT。主节点的写操作如果很频繁，从节点的同步延迟将会变高，但是 MongoDB 是多个线程进行同步的，MySQL 只有一个线程。</p><p><strong>节点间选举是如何完成的？</strong> 具有投票权的节点两两之间互相发送心跳。当没有超过5次心跳时判断节点失联。如果失联的是主节点，那么就要开始选举了。选举基于 RAFT 算法，成功的必要条件是大多数投票节点存活。复制集中最多有50个节点，但是具有投票权的只有7个。</p><p>值得注意的是，复制集并没有对数据做分布式存储，只是简单的热备份。Oplog本质上也是一个 <code>Collection</code> 存储在 <code>local</code> 数据库中。</p><p><strong>影响选举的因素有哪些呢？</strong> 首先整个集群必须有大多数节点存活，被选举的主节点必须能够与多数节点建立连接，具有较新的 Oplog，具有较高的优先级（如果通过配置文件配置）。</p><p>复制集节点有常见以下几个配置：</p><ul><li><code>v</code> 参数用于决定是否具有投票权。</li><li><code>priority</code> 参数用来配置选举优先级。当值为0的时候无法成为主节点。</li><li><code>hidden</code> 参数用来配置复制数据，但是对于应用不可见，隐藏的节点具备投票权但是优先级必须为0。</li><li><code>slaveDelay</code> 参数用于复制n秒之前的数据，保持与主节点的时间差，可以用于防止数据误删除。</li></ul><p>要启用复制集，只要在配置文件中增加：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#ff6ac1>replication</span>:
</span></span><span style=display:flex><span>    <span style=color:#ff6ac1>replSetName</span>: 复制集名称
</span></span></code></pre></td></tr></table></div></div><p>当所有节点启动以后，它们还都是独立运行的，通过 MongoDB Shell 连接到一个节点，然后执行配置操作：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>rs.initiate() <span style=color:#78787e>// 执行后当前节点会变成从节点，通过 rs.status() 可以看到。
</span></span></span><span style=display:flex><span><span style=color:#78787e></span>rs.add(<span style=color:#5af78e>&#34;主机名:端口&#34;</span>)
</span></span><span style=display:flex><span>rs.add(<span style=color:#5af78e>&#34;主机名:端口&#34;</span>)
</span></span></code></pre></td></tr></table></div></div><p>或者直接提供一个配置文件：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>rs.initiate({
</span></span><span style=display:flex><span>    _id<span style=color:#ff6ac1>:</span> <span style=color:#5af78e>&#34;rs0&#34;</span>,
</span></span><span style=display:flex><span>    members<span style=color:#ff6ac1>:</span> [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            _id<span style=color:#ff6ac1>:</span> <span style=color:#ff9f43>0</span>,
</span></span><span style=display:flex><span>            host<span style=color:#ff6ac1>:</span> <span style=color:#5af78e>&#34;主机名:端口&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            _id<span style=color:#ff6ac1>:</span> <span style=color:#ff9f43>2</span>,
</span></span><span style=display:flex><span>            host<span style=color:#ff6ac1>:</span> <span style=color:#5af78e>&#34;主机名:端口&#34;</span>
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            _id<span style=color:#ff6ac1>:</span> <span style=color:#ff9f43>3</span>,
</span></span><span style=display:flex><span>            host<span style=color:#ff6ac1>:</span> <span style=color:#5af78e>&#34;主机名:端口&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>})
</span></span></code></pre></td></tr></table></div></div><p>以上这种方式需要 DNS 解析。</p><p>对于复制集来说，推荐所有的节点配置都一样，因为任何节点都有可能成为主节点，并且硬件上必须具有独立性。MongoDB 部署复制集的时候软件版本必须一致。对于复制集来说，由于只有主节点承担写请求，那么增加节点不会增加系统的写性能。</p><p>默认只能从主节点进行读写，如果从从节点进行读操作，会收到错误提示，通过执行下面的命令允许在从节点读取：</p><div class=highlight><div style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#e2e4e5;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>rs.slaveOk()
</span></span></code></pre></td></tr></table></div></div><p>对于复制集的配置信息，通过 <code>rs.config()</code> 可以查看到。</p><h2 id=分片集>分片集</h2><p>mongos 前面无需任何负载均衡服务，mongos 会自动进行负载均衡。</p><p>MongoDB 最多支持 1024 个分片。MongoDB 分片集中的 mongos 是无状态服务，用于转发应用请求，选择合适的节点承担负载，合并多个节点的数据进行返回，建议部署至少2个。
config 服务本质上是一个 MongoDB 复制集，用于存储集群的元数据，比如数据映射关系。MongoDB 的每一个分片都是一个完整的复制集，由于数据分散在不同的分片上，缺少任何一个分片，MongoDB 所提供的数据都是不完整的。</p><p>MongoDB 分片集对应用时全透明的，并且数据会自动均衡，动态扩缩容并且无须下线，并且提供了三种分片方式：</p><ul><li>基于范围：范围查询性能好，但是数据容易不均匀。虽然优化了读取但是可能存在热点数据。</li><li>基于 Hash：数据分布均匀，针对写进行优化，但是范围查询效率低，适用于物联网、日志等场景。</li><li>基于 Zone/Tag：通过标签的方式用于全球区域化读取和写入。</li></ul><p>设计分片集群的原则：</p><ul><li>分片大小：尽量将每个分片的数据量控制到 3TB 之内，常用的索引必须能够容纳进内存。</li></ul><h2 id=sql-转换>SQL 转换</h2><p>MongoDB 的企业版提供了 MongoDB BI Connector，用于将 SQL 转换为 MongoDB 的执行语句，并且将 MongoDB 返回的 ResultSet 转换为 SQL 所用的返回，但是并不支持写入。</p><h2 id=ops-manager>Ops Manager</h2><p>MongoDB Ops Manager 是 MongoDB 用 Java 开发的集群管理平台，用于自动化监控 MongoDB，监控和报警，与 Kubernetes 集成。</p><h1 id=场景>场景</h1></div></div><footer id=footer><div class=footer-inner><div><div style=font-weight:700;margin-bottom:15px>发布地址</div><div><a href=https://halo.wecomz.com>Halo的主页</a></div><div><a href=https://bluemiaomiao.gitee.io>中国境内镜像</a></div><div><a href=https://bluemiaomiao.github.io>中国境外镜像</a></div></div><div><div style=font-weight:700;margin-bottom:15px>友情链接</div><div><a href=https://debuginn.cn>DebugInn</a></div><div><a href=https://blog.csdn.net/qq_43442524>普通Gopher</a></div></div><div><div style=font-weight:700;margin-bottom:15px>开源软件</div><div><a href=https://bluemiaomiao.github.io/libsshd/>OpenSSH Configuration Library</a></div><div><a href=https://bluemiaomiao.github.io/fastdfs-spring-boot-starter/>FastDFS SpringBoot Starter</a></div><div><a href=https://bluemiaomiao.github.io/librocm-smi-gobinding/>AMD ROCm SMI for Golang</a></div><div><a href=https://bluemiaomiao.github.io/libnvml-smi-gobinding>NVIDIA NVML SMI for Golang</a></div><div><a href=https://www.wecomz.com/software/zgraphics>zGraphics(Prometheus GPU Exporter)</a></div><div><a href=https://www.wecomz.com/software/ztrader>zTrader Framework</a></div></div><div><div style=font-weight:700;margin-bottom:15px>其他</div><div><a href=https://values.wecomz.com>WecomZ 价值观</a></div></div></div><div class=icp><div style=min-height:13px;min-width:13px;background-image:url(/image/beian.png);background-repeat:no-repeat;background-size:contain;margin-right:5px></div><div><a href=https://beian.miit.gov.cn target=_blank>鲁ICP备2023019133号</a></div></div></footer></body><script src=../../js/halo.js type=text/javascript></script></html>